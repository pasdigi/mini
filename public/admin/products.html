<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin - Produk</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">
  <div class="flex h-screen bg-gray-200">
    <div class="w-64 bg-gray-800 text-white p-4">
      <h2 class="text-2xl font-bold mb-6">Admin Paspay</h2>
      <nav>
        <a href="/admin/dashboard.html" class="block py-2.5 px-4 rounded hover:bg-gray-700">Dashboard</a>
        <a href="/admin/products.html" class="block py-2.5 px-4 rounded bg-gray-700">Produk</a>
        <a href="/admin/categories.html" class="block py-2.5 px-4 rounded hover:bg-gray-700">Kategori</a>
        <a href="/admin/orders.html" class="block py-2.5 px-4 rounded hover:bg-gray-700">Orders</a>
        <a href="/admin/users.html" class="block py-2.5 px-4 rounded hover:bg-gray-700">Users</a>
      </nav>
    </div>

    <div class="flex-1 flex flex-col overflow-hidden">
      <header class="bg-white shadow-md p-4 flex justify-between items-center">
        <h1 class="text-2xl font-semibold text-gray-700">Manajemen Produk</h1>
        <button id="add-new-btn" class="bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700">Tambah Produk Baru</button>
      </header>

      <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">
        <div class="bg-white p-6 rounded-lg shadow-md">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Kategori</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tipe</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Harga</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Aksi</th>
              </tr>
            </thead>
            <tbody id="products-table" class="bg-white divide-y divide-gray-200">
              <tr><td colspan="6" class="p-4 text-center text-gray-500">Memuat...</td></tr>
            </tbody>
          </table>
        </div>
      </main>
    </div>
  </div>

  <!-- Modal Form Produk -->
  <div id="product-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden p-4">
    <div class="relative w-full max-w-4xl bg-white rounded-lg shadow-lg p-6">
      <h3 id="form-title" class="text-2xl font-semibold mb-4">Tambah Produk Baru</h3>
      <form id="product-form" class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="md:col-span-2 space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">Nama Produk</label>
            <input id="name" name="name" required class="mt-1 w-full px-3 py-2 border rounded-lg">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Deskripsi</label>
            <textarea id="description" name="description" rows="4" class="mt-1 w-full px-3 py-2 border rounded-lg"></textarea>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Galeri</label>
            <div id="gallery-preview" class="flex flex-wrap gap-2 mt-2"></div>
            <button type="button" class="open-explorer-btn text-sm text-blue-600" data-target="gallery">Buka Image Explorer (Galeri)</button>
          </div>
          <div id="stock-section" class="hidden">
            <label class="block text-sm font-medium text-gray-700">Tambah Stok Unik (satu per baris)</label>
            <textarea id="stock_items" class="mt-1 w-full px-3 py-2 border rounded-lg" rows="4"></textarea>
            <div id="existing-stock-list" class="mt-2 text-xs text-gray-600"></div>
          </div>
        </div>

        <div class="md:col-span-1 space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">Harga (Rp)</label>
            <input id="price" name="price" type="number" required class="mt-1 w-full px-3 py-2 border rounded-lg">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700">Kategori</label>
            <select id="category_id" class="mt-1 w-full px-3 py-2 border rounded-lg"></select>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700">Tipe Produk</label>
            <select id="product_type" class="mt-1 w-full px-3 py-2 border rounded-lg">
              <option value="STANDARD">STANDARD</option>
              <option value="UNIQUE">UNIQUE</option>
            </select>
          </div>

          <div id="digital-content-section">
            <label class="block text-sm font-medium text-gray-700">Konten Digital (STANDARD)</label>
            <input id="digital_content" class="mt-1 w-full px-3 py-2 border rounded-lg">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700">Featured Image</label>
            <img id="featured-image-preview" src="https://placehold.co/400x300/e2e8f0/cbd5e0?text=Pilih" class="w-full h-40 object-cover rounded-md mb-2">
            <input type="hidden" id="image_url">
            <button type="button" class="open-explorer-btn text-sm text-blue-600" data-target="featured">Buka Image Explorer (Featured)</button>
          </div>

          <div class="flex items-center justify-between mt-2">
            <label class="flex items-center gap-2">
              <input id="is_active" type="checkbox" class="h-4 w-4">
              <span class="text-sm">Aktif (tampilkan di toko)</span>
            </label>
            <div>
              <button type="button" id="modal-close-btn" class="bg-gray-200 text-gray-700 py-2 px-4 rounded-lg">Batal</button>
              <button type="submit" id="save-product-btn" class="bg-blue-600 text-white py-2 px-4 rounded-lg">Simpan Produk</button>
            </div>
          </div>
        </div>
      </form>
      <p id="form-message" class="text-sm mt-3"></p>
    </div>
  </div>

  <!-- Explorer modal (kept minimal) -->
  <div id="explorer-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden p-4">
    <div class="relative w-full max-w-6xl mx-auto bg-white rounded-lg p-6 overflow-auto">
      <h3 class="text-lg font-semibold mb-4">Image Explorer</h3>
      <div id="explorer-grid" class="grid grid-cols-6 gap-4"></div>
      <button id="explorer-close-btn" class="absolute top-4 right-4 text-2xl">&times;</button>
    </div>
  </div>

  <script>
    const API_PRODUCTS = '/api/admin/products';
    const API_CATEGORIES = '/api/admin/categories';
    const productTable = document.getElementById('products-table');
    const addNewBtn = document.getElementById('add-new-btn');
    const productModal = document.getElementById('product-modal');
    const modalCloseBtn = document.getElementById('modal-close-btn');
    const productForm = document.getElementById('product-form');
    const formTitle = document.getElementById('form-title');
    const saveBtn = document.getElementById('save-product-btn');
    const formMessage = document.getElementById('form-message');

    // Form fields
    const productIdField = document.getElementById('product-id') || (() => { const i = document.createElement('input'); i.type='hidden'; i.id='product-id'; productForm.appendChild(i); return i; })();
    const nameField = document.getElementById('name');
    const descriptionField = document.getElementById('description');
    const priceField = document.getElementById('price');
    const categorySelect = document.getElementById('category_id');
    const productTypeField = document.getElementById('product_type');
    const digitalContentField = document.getElementById('digital_content');
    const imageUrlField = document.getElementById('image_url');
    const featuredImagePreview = document.getElementById('featured-image-preview');
    const galleryPreview = document.getElementById('gallery-preview');
    const stockSection = document.getElementById('stock-section');
    const stockTextarea = document.getElementById('stock_items');
    const existingStockList = document.getElementById('existing-stock-list');
    const isActiveCheckbox = document.getElementById('is_active');

    // Explorer
    const explorerModal = document.getElementById('explorer-modal');
    const explorerGrid = document.getElementById('explorer-grid');
    const explorerCloseBtn = document.getElementById('explorer-close-btn');
    let currentExplorerTarget = 'featured';
    let currentGallery = [];

    function showMessage(text, isError=false, timeout=4000) {
      formMessage.textContent = text;
      formMessage.className = isError ? 'text-sm mt-3 text-red-600' : 'text-sm mt-3 text-green-600';
      if (timeout) setTimeout(()=> formMessage.textContent='', timeout);
    }

    function openModal() { productModal.classList.remove('hidden'); }
    function closeModal() { productModal.classList.add('hidden'); resetForm(); }
    function openExplorer(target) { currentExplorerTarget = target; explorerModal.classList.remove('hidden'); }
    function closeExplorer() { explorerModal.classList.add('hidden'); }

    // parse server responses safely
    async function parseJson(res) {
      const txt = await res.text();
      try { return JSON.parse(txt); } catch { return txt; }
    }

    async function fetchCategories() {
      try {
        const res = await fetch(API_CATEGORIES, { credentials: 'include' });
        if (!res.ok) throw new Error(await res.text());
        const cats = await res.json();
        categorySelect.innerHTML = '<option value="">-- Pilih Kategori --</option>';
        cats.forEach(c => categorySelect.innerHTML += `<option value="${c.id}">${escapeHtml(c.name)}</option>`);
      } catch (e) {
        categorySelect.innerHTML = '<option value="">Gagal memuat</option>';
        console.error('fetchCategories', e);
      }
    }

    async function loadProducts() {
      productTable.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500">Memuat...</td></tr>';
      try {
        const res = await fetch(API_PRODUCTS, { credentials: 'include' });
        if (!res.ok) {
          const txt = await parseJson(res);
          throw new Error(typeof txt === 'string' ? txt : (txt.error || JSON.stringify(txt)));
        }
        const data = await res.json();
        // data may be array or object (legacy); support both
        const list = Array.isArray(data) ? data : (data.data || data.results || data.products || []);
        renderProducts(list);
      } catch (err) {
        productTable.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-red-500">Gagal memuat produk: ${escapeHtml(err.message || String(err))}</td></tr>`;
        console.error('loadProducts', err);
      }
    }

    function renderProducts(list) {
      if (!list || list.length === 0) {
        productTable.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500">Belum ada produk.</td></tr>';
        return;
      }
      productTable.innerHTML = '';
      list.forEach(p => {
        const tr = document.createElement('tr');
        tr.dataset.id = p.id;
        const activeBadge = (p.is_active === 0 || p.is_active === '0' || p.is_active === false) ? 
          '<span class="px-2 py-1 text-xs rounded bg-red-100 text-red-700">Nonaktif</span>' :
          '<span class="px-2 py-1 text-xs rounded bg-green-100 text-green-700">Aktif</span>';
        tr.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${escapeHtml(p.name)}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${escapeHtml(p.category_name || '-')}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${escapeHtml(p.product_type || '-')}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">Rp ${new Intl.NumberFormat('id-ID').format(Number(p.price||0))}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${activeBadge}</td>
          <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
            <button class="text-blue-600 hover:text-blue-900 edit-btn">Edit</button>
            <button class="text-yellow-600 hover:text-yellow-900 ml-4 toggle-btn">${(p.is_active===0||p.is_active==='0'||p.is_active===false) ? 'Aktifkan' : 'Nonaktifkan'}</button>
            <button class="text-red-600 hover:text-red-900 ml-4 delete-btn">Hapus</button>
          </td>
        `;
        productTable.appendChild(tr);
      });
    }

    // Edit / Delete / Toggle handlers
    productTable.addEventListener('click', async (e) => {
      const row = e.target.closest('tr');
      if (!row) return;
      const id = row.dataset.id;
      if (e.target.classList.contains('edit-btn')) {
        // load product detail to populate form
        try {
          const res = await fetch(`${API_PRODUCTS}/${id}`, { credentials: 'include' });
          if (!res.ok) throw new Error(await res.text());
          const prod = await res.json();
          // prod may include gallery, etc.
          fillFormForEdit(prod);
          openModal();
        } catch (err) {
          alert('Gagal memuat produk: ' + (err.message || String(err)));
          console.error(err);
        }
      } else if (e.target.classList.contains('delete-btn')) {
        if (!confirm('Yakin ingin menghapus produk ini?')) return;
        try {
          const res = await fetch(`${API_PRODUCTS}/${id}`, { method: 'DELETE', credentials: 'include' });
          if (!res.ok) throw new Error(await res.text());
          showMessage('Produk dihapus', false);
          loadProducts();
        } catch (err) {
          alert('Gagal hapus produk: ' + (err.message || String(err)));
        }
      } else if (e.target.classList.contains('toggle-btn')) {
        // toggle is_active: fetch product, flip is_active, then PUT full product payload
        try {
          const getRes = await fetch(`${API_PRODUCTS}/${id}`, { credentials: 'include' });
          if (!getRes.ok) throw new Error(await getRes.text());
          const prod = await getRes.json();
          // Determine current is_active (may be null/undefined)
          const cur = prod.is_active === 0 || prod.is_active === '0' || prod.is_active === false ? 0 : 1;
          const newVal = cur === 1 ? 0 : 1;
          // Build payload using existing fields (server expects full product schema)
          const payload = {
            name: prod.name,
            description: prod.description,
            price: Number(prod.price || 0),
            product_type: prod.product_type || 'STANDARD',
            digital_content: prod.digital_content || null,
            image_url: prod.image_url || prod.image || null,
            category_id: prod.category_id || null,
            is_active: Boolean(newVal)
          };
          const putRes = await fetch(`${API_PRODUCTS}/${id}`, {
            method: 'PUT',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          if (!putRes.ok) {
            const body = await parseJson(putRes);
            throw new Error(typeof body === 'string' ? body : (body.error || JSON.stringify(body)));
          }
          showMessage(`Status produk diperbarui`, false);
          await loadProducts();
        } catch (err) {
          alert('Gagal mengubah status: ' + (err.message || String(err)));
          console.error('toggle-btn', err);
        }
      }
    });

    function fillFormForEdit(prod) {
      formTitle.textContent = `Edit Produk: ${prod.name}`;
      document.getElementById('product-id').value = prod.id;
      nameField.value = prod.name || '';
      descriptionField.value = prod.description || '';
      priceField.value = prod.price || '';
      categorySelect.value = prod.category_id || '';
      productTypeField.value = prod.product_type || 'STANDARD';
      digitalContentField.value = prod.digital_content || '';
      imageUrlField.value = prod.image_url || prod.image || '';
      featuredImagePreview.src = prod.image_url || prod.image || 'https://placehold.co/400x300/e2e8f0/cbd5e0?text=Pilih';
      // gallery
      currentGallery = (prod.gallery || []).map(g => (g.image_url || g));
      renderGalleryPreview();
      // is_active may be null/undefined -> treat null as true (displayed earlier shows null as aktif)
      isActiveCheckbox.checked = !(prod.is_active === 0 || prod.is_active === '0' || prod.is_active === false);
      // existing stock list for UNIQUE
      if (prod.product_type === 'UNIQUE') {
        document.getElementById('stock-section').classList.remove('hidden');
        loadExistingStock(prod.id);
      } else {
        document.getElementById('stock-section').classList.add('hidden');
        existingStockList.innerHTML = '';
      }
    }

    async function loadExistingStock(productId) {
      try {
        const res = await fetch(`${API_PRODUCTS}/${productId}/stock`, { credentials: 'include' });
        if (!res.ok) throw new Error(await res.text());
        const list = await res.json();
        if (Array.isArray(list) && list.length > 0) {
          existingStockList.innerHTML = `<strong>Stok tersedia:</strong><ul class="list-disc pl-5 mt-1">${list.map(s => `<li>${escapeHtml(s.content)}</li>`).join('')}</ul>`;
        } else {
          existingStockList.innerHTML = '<em class="text-xs text-gray-500">Belum ada stok unik.</em>';
        }
      } catch (err) {
        existingStockList.innerHTML = '<em class="text-xs text-gray-500">Gagal memuat stok.</em>';
        console.error('loadExistingStock', err);
      }
    }

    // Form submit (create/update)
    productForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      saveBtn.disabled = true;
      const id = document.getElementById('product-id').value;
      const payload = {
        name: nameField.value.trim(),
        description: descriptionField.value.trim(),
        price: Number(priceField.value || 0),
        product_type: productTypeField.value,
        digital_content: digitalContentField.value.trim() || null,
        image_url: imageUrlField.value || null,
        category_id: categorySelect.value ? Number(categorySelect.value) : null,
        is_active: isActiveCheckbox.checked
      };

      const method = id ? 'PUT' : 'POST';
      const url = id ? `${API_PRODUCTS}/${id}` : API_PRODUCTS;

      try {
        const res = await fetch(url, {
          method,
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!res.ok) {
          const body = await parseJson(res);
          throw new Error(typeof body === 'string' ? body : (body.error || JSON.stringify(body)));
        }
        const result = await res.json();
        // gallery sync if any
        if (currentGallery.length > 0) {
          try {
            await fetch(`${API_PRODUCTS}/${id || result.id}/gallery`, {
              method: 'POST',
              credentials: 'include',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ images: currentGallery })
            });
          } catch (gerr) {
            console.warn('Gallery sync failed', gerr);
          }
        }
        // stock add if UNIQUE
        if (payload.product_type === 'UNIQUE' && stockTextarea.value.trim()) {
          try {
            await fetch(`${API_PRODUCTS}/${id || result.id}/stock`, {
              method: 'POST',
              credentials: 'include',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ stock_items: stockTextarea.value.split('\n').map(s => s.trim()).filter(Boolean) })
            });
          } catch (serr) { console.warn('Stock add failed', serr); }
        }

        showMessage('Produk berhasil disimpan', false);
        closeModal();
        await loadProducts();
      } catch (err) {
        showMessage('Gagal menyimpan: ' + (err.message || String(err)), true, 6000);
        console.error('save product', err);
      } finally {
        saveBtn.disabled = false;
      }
    });

    // Gallery helpers
    function renderGalleryPreview() {
      galleryPreview.innerHTML = '';
      currentGallery.forEach((url, idx) => {
        const wrap = document.createElement('div');
        wrap.className = 'relative w-20 h-20';
        wrap.innerHTML = `<img src="${url}" class="w-full h-full object-cover rounded-md"><button data-index="${idx}" class="remove-gallery-btn absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center">&times;</button>`;
        galleryPreview.appendChild(wrap);
      });
    }
    galleryPreview.addEventListener('click', (e) => {
      if (e.target.classList.contains('remove-gallery-btn')) {
        const idx = Number(e.target.dataset.index);
        currentGallery.splice(idx, 1);
        renderGalleryPreview();
      }
    });

    // Explorer interactions (simple manifest-driven)
    async function loadImageManifest() {
      try {
        const res = await fetch('/image-manifest.json');
        if (!res.ok) throw new Error('manifest not found');
        const imgs = await res.json();
        explorerGrid.innerHTML = '';
        imgs.forEach(u => {
          const img = document.createElement('img');
          img.src = u; img.dataset.url = u;
          img.className = 'w-full h-24 object-cover rounded-md cursor-pointer';
          explorerGrid.appendChild(img);
        });
      } catch (err) {
        explorerGrid.innerHTML = '<p class="text-red-500 col-span-full">Gagal memuat gambar.</p>';
      }
    }

    explorerGrid.addEventListener('click', (e) => {
      if (e.target.tagName === 'IMG') {
        const url = e.target.dataset.url;
        if (currentExplorerTarget === 'featured') {
          imageUrlField.value = url;
          featuredImagePreview.src = url;
        } else {
          if (!currentGallery.includes(url)) currentGallery.push(url);
          renderGalleryPreview();
        }
        closeExplorer();
      }
    });

    document.querySelectorAll('.open-explorer-btn').forEach(b => b.addEventListener('click', (ev) => {
      openExplorer(ev.currentTarget.dataset.target);
    }));
    explorerCloseBtn.addEventListener('click', closeExplorer);

    addNewBtn.addEventListener('click', () => {
      document.getElementById('product-id').value = '';
      formTitle.textContent = 'Tambah Produk Baru';
      isActiveCheckbox.checked = true;
      stockTextarea.value = '';
      currentGallery = [];
      renderGalleryPreview();
      document.getElementById('stock-section').classList.add('hidden');
      openModal();
    });
    modalCloseBtn.addEventListener('click', closeModal);

    // helper escape
    function escapeHtml(s) {
      if (typeof s !== 'string') return s == null ? '' : String(s);
      return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]);
    }

    // initial
    fetchCategories();
    loadProducts();
    loadImageManifest();
  </script>
</body>
</html>
