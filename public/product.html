<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title id="page-title">Memuat Detail Produk...</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;600;700;800&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/@alpinejs/collapse@3.x.x/dist/cdn.min.js" defer></script>

  <script>
    // Konfigurasi Tailwind CSS (Ulangi agar shell ini mandiri)
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#06b6d4', 600: '#0891b2', 800: '#075985' },
            accent: '#10b981',
          }
        },
        fontFamily: {
          sans: ['Inter', 'sans-serif'],
          header: ['Poppins', 'sans-serif'],
        }
      }
    }
  </script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    h1, h2, h3 { font-family: 'Poppins', sans-serif; }
    .icon-back:before { content: "←"; margin-right: 0.5rem; }
    .text-xxs { font-size: 0.65rem; line-height: 1rem; } 
  </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col">
  <div class="container mx-auto p-4 md:p-8 max-w-7xl flex-grow">
        <header class="mb-8 p-4 bg-white shadow-lg rounded-xl flex justify-between items-center border-b border-primary-200">
      <a href="/" class="flex items-center gap-3 hover:opacity-90 transition" onclick="event.preventDefault(); window.location.replace('/');">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9.75 17L9 20l-1 1h8l-1-1v-3.25m-7.5 0h15a3 3 0 003-3V8.75a3 3 0 00-3-3h-15a3 3 0 00-3 3V14a3 3 0 003 3.25z" />
        </svg>
        <h1 class="text-xl font-header font-bold text-gray-900">Digital Commerce</h1>
      </a>
      <a href="/admin/login" class="text-xs text-gray-500 hover:text-primary-600 font-medium transition py-1 px-3 border border-gray-200 rounded-lg hover:bg-gray-100">Login Admin</a>
    </header>

        <div id="product-detail-container">
        <a href="/" class="icon-back text-gray-700 hover:text-primary-600 font-medium flex items-center mb-6 transition text-sm" onclick="event.preventDefault(); window.location.replace('/');">
            Kembali ke Katalog
        </a>
        <div class="text-center p-10 bg-white rounded-xl shadow-lg">Sedang memuat detail produk...</div>
    </div>
  </div>

    <footer class="mt-8 border-t border-gray-200 py-4 bg-white">
    <div class="container mx-auto max-w-7xl px-4 md:px-8 text-center text-xs text-gray-500">
      <p>&copy; 2025 Digital Commerce. Dibuat dengan Hono & Cloudflare Pages.</p>
    </div>
  </footer>

  <script>
    // --- Utilities (Diulang agar shell ini mandiri) ---
    const API_PRODUCT_BY_SLUG = '/api/store/products/slug/';

    function escapeHtml(str) {
        if (typeof str !== 'string') return str == null ? '' : String(str);
        return str.replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]);
    }

    async function parseJsonResponse(res) {
        const txt = await res.text();
        try { return { ok: res.ok, json: JSON.parse(txt), raw: txt }; }
        catch { return { ok: res.ok, json: null, raw: txt }; }
    }

    // --- Logic Rendering Detail ---
    function renderProductDetail(p) {
        const container = document.getElementById('product-detail-container');
        const pageTitleEl = document.getElementById('page-title');
        
        pageTitleEl.textContent = `${p.name} | Digital Commerce`;

        const img = escapeHtml(p.image_url || 'https://placehold.co/800x800/f8fafc/64748b?text=PRODUK');
        const price = (typeof p.price === 'number' || !isNaN(Number(p.price))) ? new Intl.NumberFormat('id-ID').format(Number(p.price)) : '-';
        
        container.innerHTML = `
            <a href="/" class="icon-back text-gray-700 hover:text-primary-600 font-medium flex items-center mb-6 transition text-sm" onclick="event.preventDefault(); window.location.replace('/');">
                Kembali ke Katalog
            </a>
            <div class="bg-white rounded-2xl shadow-xl p-6 md:p-10 border border-gray-100">
                <div class="flex flex-col lg:flex-row gap-8">
                    <div class="lg:w-1/2">
                        <div class="aspect-square bg-gray-100 rounded-xl overflow-hidden shadow-lg border-4 border-gray-100">
                            <img src="${img}" alt="${escapeHtml(p.name)}" class="w-full h-full object-cover">
                        </div>
                    </div>
                    <div class="lg:w-1/2">
                        <span class="inline-block text-xs font-semibold text-primary-800 bg-primary-100 px-2 py-0.5 rounded-full mb-2 uppercase tracking-wide">${escapeHtml(p.category_name || 'Umum')}</span>
                        <h2 class="text-3xl font-header font-bold text-gray-900 mb-4">${escapeHtml(p.name)}</h2>
                        
                        <div class="flex items-baseline gap-3 mb-6 border-t border-b py-3 border-gray-200">
                            <span class="text-xl font-semibold text-gray-500">Harga:</span>
                            <span class="text-3xl font-header font-extrabold text-accent">Rp ${price}</span>
                        </div>

                        <h3 class="text-xl font-semibold mb-3 text-gray-800">Deskripsi</h3>
                        <p class="text-sm text-gray-600 leading-relaxed whitespace-pre-wrap">${escapeHtml(p.description || 'Deskripsi belum tersedia.')}</p>

                        <button onclick="alert('Checkout untuk ${escapeHtml(p.name)} akan segera diproses!')" class="mt-8 w-full inline-flex items-center justify-center gap-2 bg-accent text-white py-3 px-6 rounded-lg text-lg font-bold shadow-lg hover:bg-green-600 focus:outline-none focus:ring-4 focus:ring-accent/50 transition">
                            <i class="fas fa-shopping-cart h-5 w-5"></i> Beli Instan & Download
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    async function loadProductDetail() {
        const container = document.getElementById('product-detail-container');
        const pageTitleEl = document.getElementById('page-title');
        
        // 1. Ekstrak Slug dari URL
        const path = window.location.pathname;
        const match = path.match(/^\/product\/([^/]+)$/);
        
        if (!match) {
            container.innerHTML = `
                <div class="text-center p-10 bg-white rounded-xl shadow-lg border border-red-200">
                    <p class="text-xl font-header font-bold text-red-500 mb-3">400 - Permintaan Buruk</p>
                    <p class="text-sm text-gray-700">URL produk tidak valid.</p>
                    <a href="/" class="mt-4 icon-back inline-flex items-center text-primary-600 hover:text-primary-800 font-medium transition" onclick="event.preventDefault(); window.location.replace('/');">
                        Kembali ke Katalog
                    </a>
                </div>
            `;
            return;
        }

        const slug = decodeURIComponent(match[1]);
        
        try {
            const res = await fetch(`${API_PRODUCT_BY_SLUG}${encodeURIComponent(slug)}`);
            const parsed = await parseJsonResponse(res);

            if (!res.ok) {
                container.innerHTML = `
                    <div class="text-center p-10 bg-white rounded-xl shadow-lg border border-red-200">
                        <p class="text-xl font-header font-bold text-red-500 mb-3">404 - Tidak Ditemukan</p>
                        <p class="text-sm text-gray-700">Produk **${escapeHtml(slug)}** tidak tersedia.</p>
                        <a href="/" class="mt-4 icon-back inline-flex items-center text-primary-600 hover:text-primary-800 font-medium transition" onclick="event.preventDefault(); window.location.replace('/');">
                            Kembali ke Katalog
                        </a>
                    </div>
                `;
                pageTitleEl.textContent = '404 - Tidak Ditemukan';
                return;
            }

            renderProductDetail(parsed.json);

        } catch (err) {
            container.innerHTML = '<div class="text-center p-4 bg-red-50 rounded-xl shadow border border-red-200 text-red-700 text-sm font-medium">Terjadi kesalahan sistem saat memuat detail produk.</div>';
        }
    }

    // Panggil fungsi saat shell dimuat
    window.addEventListener('load', loadProductDetail);
  </script>
</body>
</html>
