<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toko Online Simple</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLMDJd/r0s+Qj+zJShY/i3U74N9w6+F3U4g1V6A5i3z8p6M5v4Z1+K2Q2Z6X2g==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.1/dist/cdn.min.js"></script>

    <script>
        // Konfigurasi Tailwind untuk warna primer yang lebih mudah dikontrol
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                        },
                    }
                }
            }
        }
    </script>

    <style>
        /* CSS Tambahan untuk animasi sederhana */
        .card-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        @keyframes loading {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">

    <header class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto max-w-7xl px-4 py-3 flex justify-between items-center">
            <a href="/" class="text-2xl font-bold text-primary-600">
                <i class="fas fa-store mr-2"></i> Toko Simple
            </a>
            <div class="flex items-center space-x-4">
                <div class="hidden lg:block">
                    <input id="search-input-desktop" type="text" placeholder="Cari produk..." class="w-64 px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                </div>
                <button id="cart-button" class="text-gray-600 hover:text-primary-600 relative">
                    <i class="fas fa-shopping-cart text-xl"></i>
                    <span id="cart-count" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">0</span>
                </button>
                <a href="/admin/login" class="text-sm font-medium text-primary-600 hover:text-primary-800 hidden md:block">Login Admin</a>
            </div>
        </div>
        <div class="lg:hidden px-4 pb-3">
            <input id="search-input-mobile" type="text" placeholder="Cari produk..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
        </div>
    </header>


    <div class="container mx-auto max-w-7xl px-4 py-8">
        
        <div id="product-list-page" class="hidden">
            
            <div class="lg:hidden mb-6 flex space-x-3">
                
                <div x-data="{ openCat: false }" class="relative w-1/2">
                    <button @click="openCat = !openCat" class="w-full flex justify-between items-center px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50">
                        <span id="selectedCategoryNameMobile">Semua Kategori</span>
                        <i :class="openCat ? 'fa-chevron-up' : 'fa-chevron-down'" class="fas ml-2"></i>
                    </button>
                    <div x-show="openCat" @click.outside="openCat = false" 
                         class="absolute z-40 mt-1 w-full rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none"
                         x-transition:enter="transition ease-out duration-100"
                         x-transition:enter-start="transform opacity-0 scale-95"
                         x-transition:enter-end="transform opacity-100 scale-100"
                         x-transition:leave="transition ease-in duration-75"
                         x-transition:leave-start="transform opacity-100 scale-100"
                         x-transition:leave-end="transform opacity-0 scale-95">
                        <div id="category-options-mobile" class="py-1 max-h-60 overflow-y-auto" role="menu" aria-orientation="vertical" aria-labelledby="category-menu">
                            </div>
                    </div>
                </div>

                <div class="w-1/2">
                    <select id="sort-select-mobile" class="w-full block px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm font-medium text-gray-700 focus:ring-primary-500 focus:border-primary-500">
                        </select>
                </div>

            </div>

            <div class="lg:grid lg:grid-cols-12 lg:gap-8">
                
                <aside id="category-sidebar" class="hidden lg:block lg:col-span-3 lg:sticky lg:top-8">
                    <div class="p-4 bg-white rounded-xl shadow-lg">
                        <h3 class="font-bold text-lg mb-4 text-gray-800 flex items-center">
                            <i class="fas fa-filter mr-2 text-primary-500"></i> Kategori
                        </h3>
                        
                        <a id="all-products-link" href="/" onclick="event.preventDefault(); history.pushState(null, '', '/'); router();"
                           class="flex items-center px-3 py-2 text-sm rounded-lg font-medium transition bg-primary-100 text-primary-800 font-semibold">
                            <i class="fas fa-box-open w-4 mr-2 !text-primary-800"></i> Semua Produk
                        </a>

                        <div id="category-sidebar-list" class="mt-2 space-y-1">
                            </div>

                        <hr class="my-4">

                        <div>
                            <label for="sort-select-desktop" class="block text-sm font-medium text-gray-700 mb-2">Urutkan Berdasarkan</label>
                            <select id="sort-select-desktop" class="w-full block px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-primary-500 focus:border-primary-500">
                                </select>
                        </div>

                    </div>
                </aside>
                
                <main class="lg:col-span-9">
                    <h2 id="page-title" class="text-2xl font-bold text-gray-800 mb-6">Semua Produk</h2>

                    <div id="product-list" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-6">
                        </div>
                    
                    <div id="no-products-message" class="hidden text-center py-12 bg-white rounded-xl shadow-lg mt-6">
                        <i class="fas fa-exclamation-triangle text-4xl text-yellow-500 mb-4"></i>
                        <p class="text-xl font-semibold text-gray-700">Produk tidak ditemukan.</p>
                        <p class="text-gray-500 mt-2">Coba ganti kata kunci pencarian atau filter kategori.</p>
                    </div>

                </main>

            </div>
        </div>

        <div id="product-detail-page" class="hidden">
            <div class="bg-white rounded-xl shadow-lg p-6 md:p-8">
                <button onclick="history.back(); router();" class="text-primary-600 hover:text-primary-800 mb-4 flex items-center">
                    <i class="fas fa-arrow-left mr-2"></i> Kembali ke Daftar Produk
                </button>
                <div id="product-detail-content" class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    </div>
            </div>
        </div>

        <div id="global-loading" class="fixed inset-0 bg-white/70 backdrop-blur-sm z-[9999] flex items-center justify-center">
            <div class="flex flex-col items-center">
                <i class="fas fa-spinner fa-spin text-4xl text-primary-600 mb-3"></i>
                <p class="text-lg text-gray-700 font-medium">Memuat data...</p>
            </div>
        </div>

    </div>

    <footer class="mt-12 py-6 text-center text-sm text-gray-500 border-t">
        &copy; 2025 Toko Simple. Dibuat dengan Hono & Cloudflare Pages.
    </footer>


    <script>
        // --- Konfigurasi dan Elemen DOM ---
        const API_URL = '/api/store/products';
        const API_DETAIL_URL = '/api/store/products'; 

        const productListPage = document.getElementById('product-list-page');
        const productDetailPage = document.getElementById('product-detail-page');
        const productList = document.getElementById('product-list');
        const productDetailContent = document.getElementById('product-detail-content');
        const globalLoading = document.getElementById('global-loading');
        const pageTitle = document.getElementById('page-title');
        const noProductsMessage = document.getElementById('no-products-message');

        const searchInputDesktop = document.getElementById('search-input-desktop');
        const searchInputMobile = document.getElementById('search-input-mobile');
        const sortSelectDesktop = document.getElementById('sort-select-desktop');
        const sortSelectMobile = document.getElementById('sort-select-mobile');

        const categorySidebarList = document.getElementById('category-sidebar-list');
        const categoryOptionsMobile = document.getElementById('category-options-mobile');
        const allProductsLink = document.getElementById('all-products-link');
        const selectedCategoryNameMobileEl = document.getElementById('selectedCategoryNameMobile');


        const SORT_OPTIONS = [
            { label: 'Default (Nama A-Z)', value: 'name_asc' },
            { label: 'Harga Terendah', value: 'price_asc' },
            { label: 'Harga Tertinggi', value: 'price_desc' },
        ];

        // --- State Aplikasi ---
        let products = [];
        let categories = ['Semua']; // 'Semua' harus selalu ada
        let currentSearchQuery = '';
        let currentSort = SORT_OPTIONS[0].value;
        let currentCategory = 'Semua';

        // --- Utilitas ---
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);
        };

        const slugify = (text) => {
            if (!text) return '';
            return text.toString().toLowerCase()
                .trim()
                .replace(/\s+/g, '-') 
                .replace(/[^\w\-]+/g, '') 
                .replace(/\-\-+/g, '-') 
                .replace(/^-+/, '') 
                .replace(/-+$/, '');
        };

        // --- Rendering UI Komponen ---

        function renderSkeletons(count = 6) {
            productList.innerHTML = Array(count).fill(0).map(() => `
                <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                    <div class="h-48 card-skeleton"></div>
                    <div class="p-5">
                        <div class="h-6 w-3/4 mb-2 card-skeleton rounded"></div>
                        <div class="h-4 w-1/3 mb-4 card-skeleton rounded"></div>
                        <div class="h-4 w-full mb-3 card-skeleton rounded"></div>
                        <div class="h-4 w-2/3 mb-4 card-skeleton rounded"></div>
                        <div class="h-10 w-full card-skeleton rounded-lg"></div>
                    </div>
                </div>
            `).join('');
        }

        function renderProductCard(product) {
            const url = `/?product=${product.slug || product.id}`;
            const priceHtml = product.price ? 
                `<p class="text-lg font-bold text-primary-600">${formatCurrency(product.price)}</p>` :
                `<p class="text-lg font-bold text-gray-500">Harga Tidak Tersedia</p>`;

            return `
                <div class="bg-white rounded-xl shadow-lg hover:shadow-xl transition duration-300 overflow-hidden flex flex-col">
                    <img src="${product.image_url || 'https://via.placeholder.com/400x300?text=No+Image'}" 
                         alt="${product.name}" 
                         class="w-full h-48 object-cover object-center">
                    <div class="p-5 flex flex-col flex-grow">
                        <h3 class="text-xl font-semibold text-gray-800 mb-2 truncate">${product.name}</h3>
                        <p class="text-sm text-gray-500 mb-3">${product.category_name || 'Tanpa Kategori'}</p>
                        <p class="text-gray-600 text-sm mb-4 line-clamp-2">${product.description || 'Tidak ada deskripsi singkat.'}</p>
                        <div class="mt-auto">
                            ${priceHtml}
                            <a href="${url}" onclick="event.preventDefault(); history.pushState(null, '', '${url}'); router();"
                               class="mt-3 block w-full text-center bg-primary-600 text-white font-medium py-2 rounded-lg hover:bg-primary-700 transition">
                                Lihat Detail
                            </a>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderProducts(filteredProducts) {
            productList.innerHTML = '';
            if (filteredProducts.length === 0) {
                productList.classList.add('hidden');
                noProductsMessage.classList.remove('hidden');
            } else {
                productList.classList.remove('hidden');
                noProductsMessage.classList.add('hidden');
                productList.innerHTML = filteredProducts.map(renderProductCard).join('');
            }
        }

        function renderSortOptions(selectElement, selectedValue) {
            selectElement.innerHTML = SORT_OPTIONS.map(option => 
                `<option value="${option.value}" ${option.value === selectedValue ? 'selected' : ''}>${option.label}</option>`
            ).join('');
        }
        
        function createMobileCategoryLink(label, href) {
            const link = document.createElement('a');
            link.href = href;
            link.textContent = label;
            link.className = 'text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100 transition';
            link.onclick = (e) => {
                e.preventDefault();
                history.pushState(null, '', link.href);
                router(); 
                
                // Update Mobile Display Name
                selectedCategoryNameMobileEl.textContent = label;
                
                // **PERBAIKAN LOGIKA MOBILE**: Cari komponen Alpine.js terdekat dan atur 'openCat' menjadi false untuk menutup dropdown
                let alpineComponent = e.currentTarget.closest('[x-data]');
                if (alpineComponent && alpineComponent.__x) {
                    alpineComponent.__x.$data.openCat = false; 
                }
            };
            return link;
        }

        function renderCategorySidebar(allCategories) {
            categorySidebarList.innerHTML = '';
            categoryOptionsMobile.innerHTML = ''; 
            
            // Atur Link "Semua Produk" (Desktop) dan Display Mobile
            const isAll = currentCategory === 'Semua';
            if (isAll) {
                allProductsLink.classList.remove('text-gray-700', 'hover:bg-gray-100');
                allProductsLink.classList.add('bg-primary-100', 'text-primary-800', 'font-semibold');
                allProductsLink.querySelector('i').classList.add('!text-primary-800');
                selectedCategoryNameMobileEl.textContent = 'Semua Kategori'; // Reset mobile display
            } else {
                allProductsLink.classList.add('text-gray-700', 'hover:bg-gray-100');
                allProductsLink.classList.remove('bg-primary-100', 'text-primary-800', 'font-semibold');
                allProductsLink.querySelector('i').classList.remove('!text-primary-800');
                selectedCategoryNameMobileEl.textContent = currentCategory; // Set mobile display to current category
            }

            // Render Mobile "Semua Kategori" Option
            const allMobileOption = createMobileCategoryLink('Semua Kategori', '/');
            if (isAll) allMobileOption.classList.add('bg-primary-50', 'text-primary-800', 'font-semibold');
            categoryOptionsMobile.appendChild(allMobileOption);


            allCategories.filter(c => c !== 'Semua').forEach(cat => {
                const href = `/?category=${encodeURIComponent(cat)}`; 
                
                // 1. Render Desktop Sidebar Link
                const desktopLink = document.createElement('a');
                desktopLink.href = href;
                desktopLink.className = 'flex items-center px-3 py-2 text-sm rounded-lg font-medium transition';
                desktopLink.onclick = (e) => { e.preventDefault(); history.pushState(null, '', desktopLink.href); router(); };
                desktopLink.innerHTML = `<i class="fas fa-tag w-4 mr-2 text-gray-400"></i> ${cat}`;
                
                // 2. Render Mobile Dropdown Link
                const mobileLink = createMobileCategoryLink(cat, href);

                if (cat === currentCategory) {
                    // Highlight desktop
                    desktopLink.classList.remove('text-gray-700', 'hover:bg-gray-100');
                    desktopLink.classList.add('bg-primary-100', 'text-primary-800', 'font-semibold');
                    desktopLink.querySelector('i').classList.add('!text-primary-800');

                    // Highlight mobile
                    mobileLink.classList.add('bg-primary-50', 'text-primary-800', 'font-semibold');

                } else {
                    desktopLink.classList.add('text-gray-700', 'hover:bg-gray-100');
                }

                categorySidebarList.appendChild(desktopLink);
                categoryOptionsMobile.appendChild(mobileLink);
            });
        }


        // --- Logika Filter dan Sortir ---

        function filterAndSortProducts() {
            let filtered = products.filter(p => {
                const matchesCategory = currentCategory === 'Semua' || p.category_name === currentCategory;
                const matchesSearch = !currentSearchQuery || 
                                      (p.name && p.name.toLowerCase().includes(currentSearchQuery)) ||
                                      (p.description && p.description.toLowerCase().includes(currentSearchQuery));
                return matchesCategory && matchesSearch;
            });

            filtered.sort((a, b) => {
                switch (currentSort) {
                    case 'price_asc':
                        return (a.price || 0) - (b.price || 0);
                    case 'price_desc':
                        return (b.price || 0) - (a.price || 0);
                    case 'name_asc':
                    default:
                        return a.name.localeCompare(b.name);
                }
            });

            pageTitle.textContent = currentCategory === 'Semua' ? 'Semua Produk' : `Produk Kategori: ${currentCategory}`;
            if (currentSearchQuery) {
                pageTitle.textContent += ` (Cari: "${currentSearchQuery}")`;
            }

            renderProducts(filtered);
        }

        // --- Logika Load Data ---

        async function loadProducts(refreshCategories = false) {
            try {
                globalLoading.classList.remove('hidden');
                renderSkeletons();
                
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error('Gagal memuat produk dari API');
                
                const data = await response.json();
                products = data;
                
                // Hanya update kategori jika diminta (biasanya hanya di load awal)
                if (refreshCategories) {
                    const uniqueCategories = ['Semua', ...new Set(data.map(p => p.category_name).filter(Boolean).sort())];
                    categories = uniqueCategories;
                    renderCategorySidebar(categories);
                }

                filterAndSortProducts();

            } catch (error) {
                console.error("Error loading products:", error);
                productList.innerHTML = `<div class="col-span-full text-center p-10 bg-red-100 text-red-700 rounded-lg">
                    <p class="font-bold">Gagal memuat data.</p>
                    <p>${error.message}</p>
                </div>`;
            } finally {
                globalLoading.classList.add('hidden');
            }
        }

        // --- Logika Halaman Detail Produk ---

        function renderProductDetail(p) {
            const galleryHtml = (p.gallery || []).map(imgUrl => `
                <img src="${imgUrl}" alt="Gallery image" class="w-full h-auto rounded-lg shadow-md">
            `).join('');

            productDetailContent.innerHTML = `
                <div>
                    <img src="${p.image_url || 'https://via.placeholder.com/600x450?text=Produk+Image'}" 
                         alt="${p.name}" 
                         class="w-full h-auto max-h-96 object-contain rounded-xl shadow-lg mb-6">
                    <div class="grid grid-cols-3 gap-3">
                        ${galleryHtml}
                    </div>
                </div>
                
                <div>
                    <span class="inline-block bg-primary-100 text-primary-800 text-xs font-semibold px-3 py-1 rounded-full mb-2">
                        ${p.category_name || 'Tanpa Kategori'}
                    </span>
                    <h1 class="text-3xl font-bold text-gray-900 mb-3">${p.name}</h1>
                    
                    <p class="text-2xl font-extrabold text-primary-600 mb-6">
                        ${formatCurrency(p.price)}
                    </p>
                    
                    <h2 class="text-xl font-semibold text-gray-800 mb-2">Deskripsi</h2>
                    <p class="text-gray-600 leading-relaxed whitespace-pre-wrap">${p.description || 'Tidak ada deskripsi lengkap.'}</p>
                    
                    <button class="mt-8 w-full bg-green-500 text-white font-semibold py-3 rounded-lg hover:bg-green-600 transition">
                        <i class="fas fa-shopping-bag mr-2"></i> Beli Sekarang
                    </button>
                </div>
            `;
        }
        
        async function loadProductDetail(slugOrId) {
            try {
                globalLoading.classList.remove('hidden');
                productDetailContent.innerHTML = renderDetailSkeleton(); 

                const url = slugify(slugOrId).length > 0 ? `${API_DETAIL_URL}/slug/${slugOrId}` : `${API_DETAIL_URL}/${slugOrId}`;
                
                const response = await fetch(url);
                if (response.status === 404) {
                    productDetailContent.innerHTML = renderNotFound();
                    return;
                }
                if (!response.ok) throw new Error('Gagal memuat detail produk');
                
                const product = await response.json();
                renderProductDetail(product);

            } catch (error) {
                console.error("Error loading product detail:", error);
                productDetailContent.innerHTML = `<div class="col-span-full text-center p-10 bg-red-100 text-red-700 rounded-lg">
                    <p class="font-bold">Gagal memuat detail produk.</p>
                    <p>${error.message}</p>
                </div>`;
            } finally {
                globalLoading.classList.add('hidden');
            }
        }
        
        function renderDetailSkeleton() {
            return `
                <div>
                    <div class="w-full h-96 card-skeleton rounded-xl mb-6"></div>
                    <div class="grid grid-cols-3 gap-3">
                        <div class="h-20 card-skeleton rounded"></div>
                        <div class="h-20 card-skeleton rounded"></div>
                        <div class="h-20 card-skeleton rounded"></div>
                    </div>
                </div>
                <div>
                    <div class="h-4 w-1/4 card-skeleton rounded-full mb-4"></div>
                    <div class="h-10 w-full card-skeleton rounded mb-3"></div>
                    <div class="h-8 w-1/2 card-skeleton rounded mb-6"></div>
                    
                    <div class="h-5 w-1/3 card-skeleton rounded mb-2"></div>
                    <div class="space-y-2">
                        <div class="h-4 w-full card-skeleton rounded"></div>
                        <div class="h-4 w-5/6 card-skeleton rounded"></div>
                        <div class="h-4 w-4/5 card-skeleton rounded"></div>
                    </div>
                    <div class="h-12 w-full card-skeleton rounded-lg mt-8"></div>
                </div>
            `;
        }

        function renderNotFound() {
            return `
                <div class="col-span-full text-center py-20">
                    <i class="fas fa-search-minus text-6xl text-gray-400 mb-4"></i>
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">404 Produk Tidak Ditemukan</h1>
                    <p class="text-gray-500">Produk yang Anda cari mungkin telah dihapus atau URL-nya salah.</p>
                </div>
            `;
        }


        // --- Routing dan Initial Load ---

        function router() {
            const path = window.location.pathname;
            const params = new URLSearchParams(window.location.search);
            const productSlug = params.get('product');
            
            // 1. Cek Halaman Detail Produk
            if (productSlug) {
                productListPage.classList.add('hidden');
                productDetailPage.classList.remove('hidden');
                loadProductDetail(productSlug);
                return;
            }

            // 2. Halaman Daftar Produk
            productListPage.classList.remove('hidden');
            productDetailPage.classList.add('hidden');

            // Ambil state dari URL/params
            const categoryParam = params.get('category');
            const searchParam = params.get('q');
            const sortParam = params.get('sort');

            // Update State Global
            currentCategory = categoryParam || 'Semua';
            currentSearchQuery = searchParam || '';
            currentSort = SORT_OPTIONS.find(opt => opt.value === sortParam)?.value || SORT_OPTIONS[0].value;

            // Update Input UI (agar sinkron)
            searchInputDesktop.value = currentSearchQuery;
            searchInputMobile.value = currentSearchQuery;
            
            renderSortOptions(sortSelectDesktop, currentSort);
            renderSortOptions(sortSelectMobile, currentSort);
            
            // Re-render sidebar dan filter produk
            renderCategorySidebar(categories); 
            filterAndSortProducts(); 
        }

        // --- Event Listeners ---
        
        // Listener Pencarian (Desktop dan Mobile)
        [searchInputDesktop, searchInputMobile].forEach(inputEl => {
            inputEl.addEventListener('input', () => {
                const query = inputEl.value.trim().toLowerCase();
                // Update URL dan router
                const url = new URL(window.location.href);
                if (query) {
                    url.searchParams.set('q', query);
                } else {
                    url.searchParams.delete('q');
                }
                // Hapus product detail jika sedang ada
                url.searchParams.delete('product'); 
                history.pushState(null, '', url.toString());
                router(); 
            });
        });

        // Listener Sortir (Desktop dan Mobile)
        [sortSelectDesktop, sortSelectMobile].forEach(selectEl => {
            selectEl.addEventListener('change', (e) => {
                const sortValue = e.target.value;
                // Update URL dan router
                const url = new URL(window.location.href);
                url.searchParams.set('sort', sortValue);
                // Hapus product detail jika sedang ada
                url.searchParams.delete('product');
                history.pushState(null, '', url.toString());
                router();
            });
        });

        // Listener Popstate (Tombol Back/Forward Browser)
        window.addEventListener('popstate', router);


        // --- Inisialisasi Aplikasi ---

        // 1. Muat data produk dan kategori sekali di awal
        // (refreshCategories = true agar kategori terisi)
        loadProducts(true).then(() => {
            // 2. Jalankan router setelah data utama dimuat
            router();
        });


    </script>
</body>
</html>
