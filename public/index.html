<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title id="page-title">Katalog Produk | Digital Commerce</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;600;700;800&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/@alpinejs/collapse@3.x.x/dist/cdn.min.js" defer></script>
  <script>
    // Konfigurasi Tailwind CSS
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#06b6d4', 600: '#0891b2', 800: '#075985' },
            accent: '#10b981',
          },
          spacing: {
            '13': '3.25rem', // 52px (untuk margin negatif)
          }
        },
        fontFamily: {
          sans: ['Inter', 'sans-serif'],
          header: ['Poppins', 'sans-serif'],
        }
      }
    }
  </script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    h1, h2, h3 { font-family: 'Poppins', sans-serif; }
    .icon-back:before { content: "←"; margin-right: 0.5rem; }
    .text-xxs { font-size: 0.65rem; line-height: 1rem; } 
    [x-cloak] { display: none !important; }
    @media (min-width: 768px) {
        .md\:mt-neg-13 { margin-top: -3.25rem; } /* -52px */
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col">
  <div class="container mx-auto p-4 md:p-8 max-w-7xl flex-grow">
        <header class="mb-8 p-4 bg-white shadow-lg rounded-xl flex justify-between items-center border-b border-primary-200">
      <a href="/" class="flex items-center gap-3 hover:opacity-90 transition" onclick="event.preventDefault(); history.pushState(null, '', '/'); router();">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9.75 17L9 20l-1 1h8l-1-1v-3.25m-7.5 0h15a3 3 0 003-3V8.75a3 3 0 00-3-3h-15a3 3 0 00-3 3V14a3 3 0 003 3.25z" />
        </svg>
        <h1 class="text-xl font-header font-bold text-gray-900">Digital Commerce</h1>
      </a>
      <a href="/admin/login" class="text-xs text-gray-500 hover:text-primary-600 font-medium transition py-1 px-3 border border-gray-200 rounded-lg hover:bg-gray-100">Login Admin</a>
    </header>

        <div id="product-list-page" class="transition-opacity duration-500">
        
        <section>
            
            <h2 class="text-2xl font-header font-semibold text-gray-800 mb-6">Katalog Produk Instan</h2>
            
            <div class="flex flex-col md:flex-row md:space-x-8">

                                <aside id="category-sidebar-desktop" class="md:w-64 flex-shrink-0 mb-6 hidden md:block">
                                        <div class="bg-white p-4 rounded-xl shadow-lg border border-gray-100 md:mt-[-52px] sticky top-4">
                        <h3 class="text-lg font-header font-semibold text-gray-800 mb-3 border-b pb-2">Kategori</h3>
                        <nav class="space-y-1 text-sm" id="category-options-desktop">
                                                    </nav>
                    </div>
                </aside>

                                <div class="md:flex-1">

                    <div class="mb-4 bg-white p-4 rounded-xl shadow-md border border-gray-100">
                        <div class="relative mb-3">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-search text-gray-400"></i>
                            </div>
                            <input id="search-mobile" type="text" placeholder="Cari di Katalog..." class="w-full pl-10 pr-3 py-2 text-sm border border-gray-300 rounded-lg focus:border-primary-500 focus:ring-0 transition">
                        </div>

                        <div class="flex gap-3">
                                        
                                                        <div class="relative w-1/2 md:hidden" x-data="{ openCat: false }">
                                <button @click="openCat = !openCat" type="button" class="w-full inline-flex justify-between items-center px-3 py-1.5 border border-gray-300 shadow-sm text-xs font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-1 focus:ring-primary-500 transition">
                                    <span id="selectedCategoryNameMobile">Semua Kategori</span>
                                    <i class="ml-2 fas fa-chevron-down text-gray-400 text-xs" :class="{ 'fa-chevron-up': openCat, 'fa-chevron-down': !openCat }"></i>
                                </button>
                                <div x-show="openCat" @click.away="openCat = false" x-transition class="origin-top-left absolute mt-2 w-full rounded-lg shadow-xl bg-white ring-1 ring-black ring-opacity-5 focus:outline-none z-10 max-h-60 overflow-y-auto" x-cloak>
                                    <div class="py-1" id="category-options-mobile">
                                    </div>
                                </div>
                            </div>
                                        
                                                        <div class="relative w-1/2 md:w-auto" x-data="{ openSortMobile: false }">
                                <button @click="openSortMobile = !openSortMobile" type="button" class="w-full inline-flex justify-between items-center px-3 py-1.5 border border-gray-300 shadow-sm text-xs font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-1 focus:ring-primary-500 transition">
                                    Urutkan: &nbsp; <span id="selectedSortNameMobile">Populer</span>
                                    <i class="ml-2 fas fa-chevron-down text-gray-400 text-xs" :class="{ 'fa-chevron-up': openSortMobile, 'fa-chevron-down': !openSortMobile }"></i>
                                </button>
                                <div x-show="openSortMobile" @click.away="openSortMobile = false" x-transition class="origin-top-right absolute right-0 mt-2 w-48 rounded-lg shadow-xl bg-white ring-1 ring-black ring-opacity-5 focus:outline-none z-10" x-cloak>
                                    <div class="py-1" id="sort-options-mobile">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                                <div class="flex flex-col sm:flex-row justify-between items-center bg-white p-3 rounded-lg shadow-sm mb-4 border border-gray-200">
                                    <div id="result-count" class="text-sm font-medium text-gray-600">Memuat...</div>
                                </div>

                                <main>
                                                                        <div id="product-list" class="grid grid-cols-2 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 md:gap-5">
                                        <template id="skeleton">
                                            <div class="animate-pulse p-3 bg-white rounded-xl shadow-md border border-gray-100">
                                                <div class="w-full aspect-square bg-gray-200 rounded-lg mb-3"></div>
                                                <div class="h-3 bg-gray-200 rounded w-3/4 mb-1"></div>
                                                <div class="h-3 bg-gray-200 rounded w-1/2 mb-3"></div>
                                                <div class="h-6 bg-primary-200 rounded-lg w-full"></div>
                                            </div>
                                        </template>

                                        <div id="loading-container" class="col-span-full">
                                            <div class="p-4 bg-white rounded-xl shadow-lg text-center text-primary-600 font-medium">Memuat produk...</div>
                                        </div>
                                    </div>

                                    <div id="error-area" class="mt-6 hidden">
                                        <p class="text-red-600 bg-red-50 border border-red-200 p-4 rounded-xl text-center text-sm font-medium">Gagal memuat produk. Silakan coba refresh.</p>
                                    </div>
                                    
                                    <div id="pagination-container" class="mt-6 flex justify-center"></div>
                                </main>
                            </div>

            </div>
        </section>
    </div>
  </div>

    <footer class="mt-8 border-t border-gray-200 py-4 bg-white">
    <div class="container mx-auto max-w-7xl px-4 md:px-8 text-center text-xs text-gray-500">
      <p>&copy; 2025 Digital Commerce. Dibuat dengan Hono & Cloudflare Pages.</p>
    </div>
  </footer>

  <script>
    // --- Utilities (Sama) ---
    function escapeHtml(str) {
      if (typeof str !== 'string') return str == null ? '' : String(str);
      return str.replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]);
    }

    async function parseJsonResponse(res) {
      const txt = await res.text();
      try { return { ok: res.ok, json: JSON.parse(txt), raw: txt }; }
      catch { return { ok: res.ok, json: null, raw: txt }; }
    }

    // --- Konstan & Elemen ---
    const API_PRODUCTS = '/api/store/products';
    
    const SORT_OPTIONS = [
      { value: 'popularity-desc', label: 'Populer' },
      { value: 'price-asc', label: 'Harga Termurah' },
      { value: 'price-desc', label: 'Harga Termahal' },
      { value: 'name-asc', label: 'Nama (A-Z)' },
      { value: 'name-desc', label: 'Nama (Z-A)' },
      { value: 'created_at-desc', label: 'Terbaru' },
    ];

    const productListPage = document.getElementById('product-list-page');
    
    const productListEl = document.getElementById('product-list');
    const skeletonTmpl = document.getElementById('skeleton');
    const errorArea = document.getElementById('error-area');
    
    const searchInputMobile = document.getElementById('search-mobile'); 

    const resultCount = document.getElementById('result-count');
    const sortOptionsMobile = document.getElementById('sort-options-mobile');
    const selectedSortNameMobileEl = document.getElementById('selectedSortNameMobile');
    
    const categoryOptionsMobile = document.getElementById('category-options-mobile');
    const selectedCategoryNameMobileEl = document.getElementById('selectedCategoryNameMobile');
    const categoryOptionsDesktop = document.getElementById('category-options-desktop');


    // State
    let products = [], categories = ['Semua'];
    let currentSearchQuery = '';
    let currentSort = SORT_OPTIONS[0].value;
    let currentCategory = 'Semua';

    // --- Logic Halaman List ---

    function renderSkeletons(count = 10) { 
      productListEl.innerHTML = '';
      for (let i = 0; i < count; i++) {
        const node = skeletonTmpl.content.cloneNode(true);
        productListEl.appendChild(node);
      }
    }

    function renderProducts(list) {
      productListEl.innerHTML = '';
      if (!list || list.length === 0) {
        productListEl.innerHTML = '<div class="col-span-full p-4 bg-white rounded-xl shadow-lg text-center text-gray-500 text-sm font-medium">Tidak ada produk yang ditemukan.</div>';
        resultCount.textContent = '0 Produk Ditemukan';
        return;
      }
      list.forEach(p => {
        const img = escapeHtml(p.image_url || 'https://placehold.co/400x400/f8fafc/64748b?text=DIGITAL');
        const name = escapeHtml(p.name || '—');
        const category = escapeHtml(p.category_name || 'Umum');
        
        const price = (typeof p.price === 'number' || !isNaN(Number(p.price))) ? new Intl.NumberFormat('id-ID').format(Number(p.price)) : '-';
        const slugOrId = encodeURIComponent(p.slug || p.id);
        const href = `/product/${slugOrId}`;

        const card = document.createElement('article');
        card.className = 'bg-white rounded-xl shadow-md overflow-hidden border border-gray-100 transition-all duration-300 hover:shadow-xl hover:scale-[1.03] transform';
        
        card.innerHTML = `
          <a href="${href}" class="block" onclick="event.preventDefault(); history.pushState(null, '', '${href}'); router();">
            <div class="w-full aspect-square bg-gray-50 overflow-hidden relative">
              <img loading="lazy" src="${img}" alt="${name}" class="w-full h-full object-cover transition-transform duration-500 hover:scale-[1.1]">
              <span class="absolute top-2 right-2 text-xs font-medium text-gray-700 bg-white px-2 py-0.5 rounded-full shadow-md border border-gray-200">${category}</span>
            </div>
            <div class="p-3">
              <h3 class="text-sm font-semibold mt-1 truncate text-gray-900">${name}</h3>
              <p class="mt-1 text-xl font-bold text-accent">Rp ${price}</p>
              
              <div class="mt-3">
                <button class="w-full inline-flex items-center justify-center gap-1 bg-primary-600 text-white py-2 px-3 rounded-lg shadow-md hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-300 font-medium text-xs transition">
                  <i class="fas fa-shopping-cart h-4 w-4"></i> Beli Instan
                </button>
              </div>
            </div>
          </a>
        `;
        productListEl.appendChild(card);
      });
      resultCount.textContent = `${list.length} Produk Ditemukan`;
    }

    function renderCategoryDropdown(allCategories) {
      categoryOptionsMobile.innerHTML = '';
      categoryOptionsDesktop.innerHTML = '';
      
      // Update Display Name Mobile
      selectedCategoryNameMobileEl.textContent = currentCategory;

      // --- 1. Render Mobile Dropdown ---
      const allMobileOption = createCategoryLink('Semua Kategori', '/', true);
      if (currentCategory === 'Semua') allMobileOption.classList.add('bg-primary-50', 'text-primary-800', 'font-semibold');
      categoryOptionsMobile.appendChild(allMobileOption);

      // --- 2. Render Desktop Sidebar ---
      const allDesktopOption = createCategoryLink('Semua Kategori', '/', false);
      if (currentCategory === 'Semua') allDesktopOption.classList.add('bg-primary-100', 'text-primary-800', 'font-semibold');
      categoryOptionsDesktop.appendChild(allDesktopOption);


      allCategories.filter(c => c !== 'Semua').forEach(cat => {
        const href = `/?category=${encodeURIComponent(cat)}`; 
        
        // Mobile
        const mobileLink = createCategoryLink(cat, href, true);
        if (cat === currentCategory) {
          mobileLink.classList.add('bg-primary-50', 'text-primary-800', 'font-semibold');
        }
        categoryOptionsMobile.appendChild(mobileLink);

        // Desktop
        const desktopLink = createCategoryLink(cat, href, false);
        if (cat === currentCategory) {
          desktopLink.classList.add('bg-primary-100', 'text-primary-800', 'font-semibold');
        }
        categoryOptionsDesktop.appendChild(desktopLink);
      });
    }

    function createCategoryLink(label, href, isMobile) {
      const link = document.createElement('a');
      link.href = href;
      link.textContent = label;
      
      if (isMobile) {
        // Kelas untuk dropdown mobile
        link.className = 'text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100 transition';
      } else {
        // Kelas untuk sidebar desktop
        link.className = 'text-gray-600 block px-3 py-1.5 rounded-lg hover:bg-gray-50 transition';
      }

      link.onclick = (e) => {
        e.preventDefault();
        history.pushState(null, '', link.href);
        router(); 
        // Update display name mobile (meskipun di desktop)
        document.getElementById('selectedCategoryNameMobile').textContent = label;
      };
      return link;
    }
    
    function renderSortOptions() {
      sortOptionsMobile.innerHTML = '';
      
      SORT_OPTIONS.forEach(opt => {
        const [sort_by, sort_order] = opt.value.split('-');
        const href = `/?category=${encodeURIComponent(currentCategory)}&sort_by=${sort_by}&sort_order=${sort_order}`;
        
        const mobileLink = document.createElement('a');
        mobileLink.href = href;
        mobileLink.textContent = opt.label;
        mobileLink.className = 'text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100 transition';
        
        if (opt.value === currentSort) {
          mobileLink.classList.add('bg-primary-50', 'text-primary-800', 'font-semibold');
          selectedSortNameMobileEl.textContent = opt.label; 
        }

        const clickHandler = (e) => {
          e.preventDefault();
          history.pushState(null, '', href);
          router();
        };
        
        mobileLink.onclick = clickHandler;
        sortOptionsMobile.appendChild(mobileLink);
      });
    }

    function filterAndSortProducts() {
      let list = products.slice();
      currentSearchQuery = searchInputMobile ? searchInputMobile.value : '';

      // 1. Filter Kategori
      if (currentCategory !== 'Semua') {
        list = list.filter(p => (p.category_name || 'Umum') === currentCategory);
      }

      // 2. Filter Pencarian
      const q = currentSearchQuery.trim().toLowerCase();
      if (q) {
        list = list.filter(p => 
          ((p.name||'').toLowerCase().includes(q) || (p.description||'').toLowerCase().includes(q) || (p.category_name||'').toLowerCase().includes(q))
        );
      }

      // 3. Sorting (Sederhana di sisi klien)
      const [sort_by, sort_order] = currentSort.split('-');
      
      list.sort((a, b) => {
        let valA, valB;
        
        switch(sort_by) {
          case 'price':
            valA = Number(a.price || 0);
            valB = Number(b.price || 0);
            break;
          case 'name':
            valA = a.name.toLowerCase();
            valB = b.name.toLowerCase();
            return sort_order === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
          case 'created_at':
            valA = Number(a.id); 
            valB = Number(b.id);
            break;
          case 'popularity':
          default:
            valA = a.name.toLowerCase();
            valB = b.name.toLowerCase();
            return valA.localeCompare(valB); 
        }
        
        if (sort_by === 'name' || sort_by === 'popularity') return 0; 
        return sort_order === 'asc' ? (valA - valB) : (valB - valA);
      });

      renderProducts(list);
      renderCategoryDropdown(categories); 
      renderSortOptions();
    }

    async function loadProducts() {
      // Logika redirect Dihapus dari sini.
      
      productListPage.classList.remove('hidden', 'opacity-0');
      
      // Simulate Data Fetch (Placeholder)
      // ====================================
      errorArea.classList.add('hidden');
      renderSkeletons(10); 
      
      try {
        const res = await fetch(API_PRODUCTS);
        const parsed = await parseJsonResponse(res);
        
        if (!res.ok) {
          productListEl.innerHTML = '<div class="col-span-full p-4 bg-red-50 rounded-xl shadow border border-red-200 text-center text-red-700 text-sm font-medium">Gagal memuat produk dari API.</div>';
          errorArea.classList.remove('hidden'); resultCount.textContent = '0 Produk Ditemukan'; return;
        }
        
        const data = Array.isArray(parsed.json) ? parsed.json : (parsed.json && (parsed.json.data || parsed.json.results || parsed.json.items)) || [];
        products = data.map(p => ({ id: p.id, slug: p.slug, name: p.name, description: p.description, price: p.price, image_url: p.image_url, category_name: p.category_name || p.category }));
        
        const set = new Set();
        products.forEach(p => set.add(p.category_name || 'Umum'));
        categories = ['Semua', ...Array.from(set).filter(Boolean).sort((a,b)=>a.localeCompare(b))];
        
        filterAndSortProducts(); 
        
      } catch (err) {
        productListEl.innerHTML = '<div class="col-span-full p-4 bg-red-50 rounded-xl shadow border border-red-200 text-center text-red-700 text-sm font-medium">Terjadi kesalahan sistem saat memuat produk.</div>';
        errorArea.classList.remove('hidden'); resultCount.textContent = '0 Produk Ditemukan';
      }
      // ====================================
    }

    // --- Client-Side Router (Diperbaiki) ---

    function router() {
      const path = window.location.pathname;
      
      // LOGIC PENTING: Jika path adalah halaman detail produk, hentikan eksekusi logic halaman list.
      if (path.startsWith('/product/')) {
        // Di lingkungan frontend sejati, Anda akan memuat halaman detail produk di sini.
        // Dalam konteks file tunggal ini, kita biarkan saja navigasi browser berjalan.
        return; 
      }
      
      // Logic penentuan filter/sort (Sama)
      const urlParams = new URLSearchParams(window.location.search);
      const urlCat = urlParams.get('category');
      currentCategory = urlCat ? decodeURIComponent(urlCat) : 'Semua';
      const urlSortBy = urlParams.get('sort_by') || 'popularity';
      const urlSortOrder = urlParams.get('sort_order') || 'desc';
      currentSort = `${urlSortBy}-${urlSortOrder}`;
      
      const selectedOption = SORT_OPTIONS.find(o => o.value === currentSort);
      if (selectedSortNameMobileEl) selectedSortNameMobileEl.textContent = selectedOption ? selectedOption.label : 'Populer';

      // Load products HANYA jika kita berada di halaman list.
      loadProducts();
    }
    
    // Debounced search handler
    let searchTimeout;
    window.handleSearchDebounced = () => {
      clearTimeout(searchTimeout); 
      searchTimeout = setTimeout(() => {
        currentSearchQuery = searchInputMobile ? searchInputMobile.value : '';
        filterAndSortProducts();
      }, 300); 
    };
    
    // Event Listener Pencarian
    if (searchInputMobile) searchInputMobile.addEventListener('input', window.handleSearchDebounced);

    // Memastikan link internal yang mengarah ke home menggunakan router
    document.querySelector('header a[href="/"]').addEventListener('click', (e) => {
      e.preventDefault();
      history.pushState(null, '', '/');
      router();
    });
    
    window.addEventListener('popstate', router);
    
    // Trigger router on load
    router();
  </script>
</body>
</html>
