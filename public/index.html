<!DOCTYPE html>
<html lang="id">
<head>
Â  <meta charset="utf-8" />
Â  <meta name="viewport" content="width=device-width,initial-scale=1" />
Â  <title id="page-title">Toko Digital Premium | Mini Commerce</title>
Â  Â  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700;800&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
Â  <script src="https://cdn.tailwindcss.com"></script>
Â  <script>
Â  Â  // Konfigurasi Tailwind CSS untuk tampilan premium
Â  Â  tailwind.config = {
Â  Â  Â  theme: {
Â  Â  Â  Â  extend: {
Â  Â  Â  Â  Â  colors: {
Â  Â  Â  Â  Â  Â  primary: {
Â  Â  Â  Â  Â  Â  Â  50: '#e0f7fa',
Â  Â  Â  Â  Â  Â  Â  100: '#b2ebf2',
Â  Â  Â  Â  Â  Â  Â  200: '#80deea',
Â  Â  Â  Â  Â  Â  Â  300: '#4dd0e1',
Â  Â  Â  Â  Â  Â  Â  400: '#26c6da',
Â  Â  Â  Â  Â  Â  Â  500: '#00bcd4', // Teal utama
Â  Â  Â  Â  Â  Â  Â  600: '#00acc1',
Â  Â  Â  Â  Â  Â  Â  700: '#0097a7',
Â  Â  Â  Â  Â  Â  Â  800: '#00838f',
Â  Â  Â  Â  Â  Â  Â  900: '#006064',
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  accent: '#3b82f6', // Biru terang untuk Harga/Aksi
Â  Â  Â  Â  Â  Â  dark: '#1e293b', // Slate 800/900 untuk background utama
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  },
Â  Â  Â  Â  fontFamily: {
Â  Â  Â  Â  Â  sans: ['Inter', 'sans-serif'],
Â  Â  Â  Â  Â  header: ['Poppins', 'sans-serif'],
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  }
Â  </script>
Â  Â  <style>
Â  Â  body { font-family: 'Inter', sans-serif; }
Â  Â  h1, h2, h3 { font-family: 'Poppins', sans-serif; }
Â  Â  .icon-cart:before { content: "ğŸ›’"; margin-right: 0.5rem; }
Â  Â  .icon-back:before { content: "â†"; margin-right: 0.5rem; }
Â  </style>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen flex flex-col">
Â  <div class="container mx-auto p-4 md:p-8 max-w-7xl flex-grow">
Â  Â  Â  Â  <header class="mb-8 p-4 bg-white shadow-xl rounded-2xl flex justify-between items-center border-t-4 border-primary-600">
Â  Â  Â  <a href="/" class="block flex items-center gap-3 hover:opacity-90 transition" onclick="event.preventDefault(); history.pushState(null, '', '/'); router();">
Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-primary-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
Â  Â  Â  Â  Â  <path stroke-linecap="round" stroke-linejoin="round" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V17a2 2 0 01-2 2z" />
Â  Â  Â  Â  </svg>
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  <h1 class="text-2xl font-header font-extrabold text-gray-900">Digital Commerce</h1>
Â  Â  Â  Â  Â  <p class="text-sm text-gray-500 mt-0.5 hidden sm:block">Tempat Terbaik untuk Produk Instan</p>
Â  Â  Â  Â  </div>
Â  Â  Â  </a>
Â  Â  Â  <a href="/admin/login" class="text-sm text-gray-600 hover:text-primary-600 font-semibold transition py-2 px-4 border rounded-lg hover:bg-gray-50">Login Admin</a>
Â  Â  </header>

Â  Â  Â  Â  <div id="product-list-page" class="transition-opacity duration-500">
Â  Â  Â  Â  <h2 class="text-3xl font-header font-bold text-gray-900 mb-6 border-b pb-2">Katalog Produk Digital</h2>

Â  Â  Â  Â  <section class="grid grid-cols-1 lg:grid-cols-[250px,1fr] gap-8">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <aside x-data="{ openParentId: null, searchInput: '' }" class="lg:sticky lg:top-8 h-fit">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-white p-6 rounded-2xl shadow-xl border border-gray-200">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-xl font-header font-semibold text-gray-800 mb-4 flex items-center gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-primary-600" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z" clip-rule="evenodd" /></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Filter & Kategori
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" x-model="searchInput" placeholder="Cari di Katalog..." class="w-full px-4 py-2 mb-4 text-sm border-2 border-gray-200 rounded-lg focus:border-primary-500 focus:ring-0 transition">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="space-y-1 mt-4 max-h-96 overflow-y-auto">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <a href="/" class="flex items-center px-3 py-2 text-sm rounded-lg font-semibold transition"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â :class="[window.location.pathname === '/' ? 'bg-primary-500 text-white shadow-md hover:bg-primary-600' : 'text-gray-700 hover:bg-gray-100']"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â onclick="event.preventDefault(); history.pushState(null, '', '/'); router();">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â   Semua Produk
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </a>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="category-sidebar-list" class="space-y-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </aside>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="lg:flex-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex flex-col sm:flex-row justify-between items-center bg-white p-4 rounded-xl shadow-md mb-6 border-l-4 border-gray-300">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="result-count" class="text-lg font-medium text-gray-700">Memuat...</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="relative mt-3 sm:mt-0" x-data="{ open: false }">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button @click="open = !open" type="button" class="inline-flex justify-center items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-primary-500 transition">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Urutkan: &nbsp; <span id="selectedSortName" class="font-semibold text-primary-700">Populer</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg class="ml-2 h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" :class="{ 'rotate-180': open }"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div x-show="open" @click.away="open = false" class="origin-top-right absolute right-0 mt-2 w-48 rounded-lg shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none z-10">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="py-1" id="sort-options-list">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <main>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="product-list" class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-4 md:gap-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <template id="skeleton">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="animate-pulse p-4 bg-white rounded-xl shadow-md border border-gray-100">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="w-full aspect-square bg-gray-200 rounded-lg mb-3"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="h-4 bg-gray-200 rounded w-3/4 mb-2"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="h-4 bg-gray-200 rounded w-1/2 mb-4"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="h-8 bg-primary-200 rounded-lg w-full"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </template>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="loading-container" class="col-span-full">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="p-6 bg-white rounded-xl shadow-lg text-center text-primary-600 font-semibold">Memuat produk...</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="error-area" class="mt-8 hidden">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-red-600 bg-red-50 border border-red-200 p-4 rounded-xl text-center font-medium">Gagal memuat produk. Silakan coba refresh.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="pagination-container" class="mt-8 flex justify-center"></div>
Â  Â  Â  Â  Â  Â  Â  Â  </main>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </section>
Â  Â  </div>

Â  Â  Â  Â  <div id="product-detail-page" class="hidden transition-opacity duration-500">
Â  Â  Â  Â  Â  </div>
Â  </div>

Â  Â  <footer class="mt-12 border-t-4 border-gray-300 py-6 bg-white shadow-inner">
Â  Â  <div class="container mx-auto max-w-7xl px-4 md:px-8 text-center text-sm text-gray-500">
Â  Â  Â  <p>&copy; 2025 Digital Commerce. Dibuat dengan Hono & Cloudflare Pages. Tampilan Premium.</p>
Â  Â  </div>
Â  </footer>

Â  <script>
Â  Â  // --- Utilities (Sama) ---
Â  Â  function escapeHtml(str) {
Â  Â  Â  if (typeof str !== 'string') return str == null ? '' : String(str);
Â  Â  Â  return str.replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]);
Â  Â  }

Â  Â  async function parseJsonResponse(res) {
Â  Â  Â  const txt = await res.text();
Â  Â  Â  try { return { ok: res.ok, json: JSON.parse(txt), raw: txt }; }
Â  Â  Â  catch { return { ok: res.ok, json: null, raw: txt }; }
Â  Â  }

Â  Â  // --- Konstan & Elemen ---
Â  Â  const API_PRODUCTS = '/api/store/products';
Â  Â  const API_PRODUCT_BY_SLUG = '/api/store/products/slug/';
Â  Â  
Â  Â  const SORT_OPTIONS = [
Â  Â  Â  { value: 'popularity-desc', label: 'Populer' },
Â  Â  Â  { value: 'price-asc', label: 'Harga Terendah' },
Â  Â  Â  { value: 'price-desc', label: 'Harga Tertinggi' },
Â  Â  Â  { value: 'name-asc', label: 'Nama (A-Z)' },
Â  Â  Â  { value: 'name-desc', label: 'Nama (Z-A)' },
Â  Â  Â  { value: 'created_at-desc', label: 'Terbaru' },
Â  Â  ];

Â  Â  const pageTitleEl = document.getElementById('page-title');
Â  Â  const productListPage = document.getElementById('product-list-page');
Â  Â  const productDetailPage = document.getElementById('product-detail-page');

Â  Â  // Elemen Halaman List
Â  Â  const productListEl = document.getElementById('product-list');
Â  Â  const skeletonTmpl = document.getElementById('skeleton');
Â  Â  const errorArea = document.getElementById('error-area');
Â  Â  const resultCount = document.getElementById('result-count');
Â  Â  const sortOptionsList = document.getElementById('sort-options-list');
Â  Â  const selectedSortNameEl = document.getElementById('selectedSortName');
Â  Â  const categorySidebarList = document.getElementById('category-sidebar-list');

Â  Â  // State (Sama seperti sebelumnya, tapi kita fokus pada pembaruan tampilan)
Â  Â  let products = [], filtered = [], categories = ['Semua'];
Â  Â  let currentSearchQuery = '';
Â  Â  let currentSort = SORT_OPTIONS[0].value;
Â  Â  let currentCategory = 'Semua';

Â  Â  // --- Logic Halaman List ---

Â  Â  function renderSkeletons(count = 8) {
Â  Â  Â  productListEl.innerHTML = '';
Â  Â  Â  for (let i = 0; i < count; i++) {
Â  Â  Â  Â  const node = skeletonTmpl.content.cloneNode(true);
Â  Â  Â  Â  productListEl.appendChild(node);
Â  Â  Â  }
Â  Â  }

Â  Â  function renderProducts(list) {
Â  Â  Â  productListEl.innerHTML = '';
Â  Â  Â  if (!list || list.length === 0) {
Â  Â  Â  Â  productListEl.innerHTML = '<div class="col-span-full p-6 bg-white rounded-xl shadow-lg text-center text-gray-500 font-medium">Tidak ada produk yang ditemukan.</div>';
Â  Â  Â  Â  resultCount.textContent = '0 Produk Ditemukan';
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  list.forEach(p => {
Â  Â  Â  Â  const img = escapeHtml(p.image_url || 'https://placehold.co/600x400/f8fafc/64748b?text=DIGITAL');
Â  Â  Â  Â  const name = escapeHtml(p.name || 'â€”');
Â  Â  Â  Â  const category = escapeHtml(p.category_name || 'Tanpa Kategori');
Â  Â  Â  Â  const price = (typeof p.price === 'number' || !isNaN(Number(p.price))) ? new Intl.NumberFormat('id-ID').format(Number(p.price)) : '-';
Â  Â  Â  Â  const slugOrId = encodeURIComponent(p.slug || p.id);
Â  Â  Â  Â  const href = `/product/${slugOrId}`;

Â  Â  Â  Â  const card = document.createElement('article');
Â  Â  Â  Â  card.className = 'bg-white rounded-xl shadow-lg overflow-hidden border border-gray-200 transition-all duration-300 hover:shadow-2xl hover:scale-[1.02] transform';
Â  Â  Â  Â  
Â  Â  Â  Â  card.innerHTML = `
Â  Â  Â  Â  Â  <a href="${href}" class="block" onclick="event.preventDefault(); history.pushState(null, '', '${href}'); router();">
Â  Â  Â  Â  Â  Â  <div class="w-full aspect-square bg-gray-50 overflow-hidden relative">
Â  Â  Â  Â  Â  Â  Â  <img loading="lazy" src="${img}" alt="${name}" class="w-full h-full object-cover transition-transform duration-500 hover:scale-[1.1]">
Â  Â  Â  Â  Â  Â  Â  <span class="absolute top-2 right-2 text-xs font-semibold text-white bg-primary-600 px-2 py-0.5 rounded-full shadow-md">${category}</span>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="p-4">
Â  Â  Â  Â  Â  Â  Â  <h3 class="text-lg font-semibold mt-1 truncate text-gray-900">${name}</h3>
Â  Â  Â  Â  Â  Â  Â  <p class="mt-1 text-2xl font-bold text-accent">Rp ${price}</p>
Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  <div class="mt-4">
Â  Â  Â  Â  Â  Â  Â  Â  <button class="w-full inline-flex items-center justify-center gap-2 bg-primary-600 text-white py-2.5 px-3 rounded-xl shadow-md hover:bg-primary-700 focus:outline-none focus:ring-4 focus:ring-primary-300 font-medium text-sm transition">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M3 1a1 1 0 000 2h1.22l.305 1.222a.997.997 0 00.01.042l1.358 5.43-.893.892C3.74 11.846 4.35 13 5.378 13h12.5a.5.5 0 000-1H5.378c-.282 0-.58.125-.712.315-.226.297-.367.73-.24 1.144L6 17a1 1 0 001 1h8a1 1 0 100-2H7.071l.78-3.124h8.43c.725 0 1.36-.36 1.733-.948l1.735-2.733a1.001 1.001 0 00.007-.803.996.996 0 00-.734-.693l-4.137-.996L12 8l-.75-3H4.22L3.916 2.042A1 1 0 003 1z" /></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Beli Instan
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </a>
Â  Â  Â  Â  `;
Â  Â  Â  Â  productListEl.appendChild(card);
Â  Â  Â  });
Â  Â  Â  resultCount.textContent = `${list.length} Produk Ditemukan`;
Â  Â  }

Â  Â  function renderCategorySidebar(allCategories) {
Â  Â  Â  categorySidebarList.innerHTML = '';
Â  Â  Â  allCategories.filter(c => c !== 'Semua').forEach(cat => {
Â  Â  Â  Â  const link = document.createElement('a');
Â  Â  Â  Â  link.href = `/?category=${encodeURIComponent(cat)}`;
Â  Â  Â  Â  link.textContent = cat;
Â  Â  Â  Â  link.className = 'flex items-center px-3 py-2 text-sm rounded-lg font-medium transition';
Â  Â  Â  Â  link.onclick = (e) => {
Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  history.pushState(null, '', link.href);
Â  Â  Â  Â  Â  router();
Â  Â  Â  Â  };
Â  Â  Â  Â  
Â  Â  Â  Â  link.setAttribute(':class', `['${cat}' === currentCategory ? 'bg-primary-100 text-primary-800 font-semibold' : 'text-gray-700 hover:bg-gray-100']`);
Â  Â  Â  Â  categorySidebarList.appendChild(link);
Â  Â  Â  });
Â  Â  }
Â  Â  
Â  Â  function renderSortOptions() {
Â  Â  Â  sortOptionsList.innerHTML = '';
Â  Â  Â  SORT_OPTIONS.forEach(opt => {
Â  Â  Â  Â  const link = document.createElement('a');
Â  Â  Â  Â  link.href = `/?sort_by=${opt.value.split('-')[0]}&sort_order=${opt.value.split('-')[1]}`;
Â  Â  Â  Â  link.textContent = opt.label;
Â  Â  Â  Â  link.className = 'text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100 transition';
Â  Â  Â  Â  if (opt.value === currentSort) {
Â  Â  Â  Â  Â  link.classList.add('bg-primary-50', 'text-primary-800', 'font-semibold');
Â  Â  Â  Â  }

Â  Â  Â  Â  link.onclick = (e) => {
Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  history.pushState(null, '', link.href);
Â  Â  Â  Â  Â  router();
Â  Â  Â  Â  };
Â  Â  Â  Â  sortOptionsList.appendChild(link);
Â  Â  Â  });
Â  Â  }


Â  Â  function filterAndSortProducts() {
Â  Â  Â  let list = products.slice();

Â  Â  Â  // 1. Filter Kategori
Â  Â  Â  if (currentCategory !== 'Semua') {
Â  Â  Â  Â  list = list.filter(p => (p.category_name || 'Tanpa Kategori') === currentCategory);
Â  Â  Â  }

Â  Â  Â  // 2. Filter Pencarian
Â  Â  Â  const q = currentSearchQuery.trim().toLowerCase();
Â  Â  Â  if (q) {
Â  Â  Â  Â  list = list.filter(p => 
Â  Â  Â  Â  Â  ((p.name||'').toLowerCase().includes(q) || (p.description||'').toLowerCase().includes(q) || (p.category_name||'').toLowerCase().includes(q))
Â  Â  Â  Â  );
Â  Â  Â  }

Â  Â  Â  // 3. Sorting
Â  Â  Â  const [sort_by, sort_order] = currentSort.split('-');
Â  Â  Â  
Â  Â  Â  // Sort logic (sederhana karena data di sisi klien)
Â  Â  Â  list.sort((a, b) => {
Â  Â  Â  Â  let valA, valB;
Â  Â  Â  Â  
Â  Â  Â  Â  switch(sort_by) {
Â  Â  Â  Â  Â  case 'price':
Â  Â  Â  Â  Â  Â  valA = Number(a.price || 0);
Â  Â  Â  Â  Â  Â  valB = Number(b.price || 0);
Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  case 'name':
Â  Â  Â  Â  Â  Â  valA = a.name.toLowerCase();
Â  Â  Â  Â  Â  Â  valB = b.name.toLowerCase();
Â  Â  Â  Â  Â  Â  return sort_order === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
Â  Â  Â  Â  Â  case 'created_at':
Â  Â  Â  Â  Â  Â  // Asumsi created_at atau id dapat digunakan sebagai proksi waktu
Â  Â  Â  Â  Â  Â  valA = Number(a.id); 
Â  Â  Â  Â  Â  Â  valB = Number(b.id);
Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  case 'popularity':
Â  Â  Â  Â  Â  default:
Â  Â  Â  Â  Â  Â  // Di sini harusnya ada logic popularitas yang lebih kompleks, kita pakai default name
Â  Â  Â  Â  Â  Â  valA = a.name.toLowerCase();
Â  Â  Â  Â  Â  Â  valB = b.name.toLowerCase();
Â  Â  Â  Â  Â  Â  return valA.localeCompare(valB); // Default asc for name
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  if (sort_by === 'name' || sort_by === 'popularity') return 0; // Sudah ditangani di atas
Â  Â  Â  Â  return sort_order === 'asc' ? (valA - valB) : (valB - valA);
Â  Â  Â  });

Â  Â  Â  renderProducts(list);
Â  Â  }

Â  Â  async function loadProducts() {
Â  Â  Â  productListPage.classList.remove('hidden', 'opacity-0');
Â  Â  Â  productDetailPage.classList.add('hidden', 'opacity-0');
Â  Â  Â  pageTitleEl.textContent = 'Katalog Produk | Digital Commerce';

Â  Â  Â  errorArea.classList.add('hidden');
Â  Â  Â  renderSkeletons(8); 
Â  Â  Â  
Â  Â  Â  try {
Â  Â  Â  Â  const res = await fetch(API_PRODUCTS);
Â  Â  Â  Â  const parsed = await parseJsonResponse(res);
Â  Â  Â  Â  
Â  Â  Â  Â  if (!res.ok) {
Â  Â  Â  Â  Â  console.error('Load products error:', parsed.raw || parsed.json || res.status);
Â  Â  Â  Â  Â  productListEl.innerHTML = '<div class="col-span-full p-6 bg-red-50 rounded-xl shadow border border-red-200 text-center text-red-700 font-medium">Gagal memuat produk dari API.</div>';
Â  Â  Â  Â  Â  errorArea.classList.remove('hidden'); resultCount.textContent = '0 Produk Ditemukan'; return;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  const data = Array.isArray(parsed.json) ? parsed.json : (parsed.json && (parsed.json.data || parsed.json.results || parsed.json.items)) || [];
Â  Â  Â  Â  products = data.map(p => ({ id: p.id, slug: p.slug, name: p.name, description: p.description, price: p.price, image_url: p.image_url, category_name: p.category_name || p.category }));
Â  Â  Â  Â  
Â  Â  Â  Â  const set = new Set();
Â  Â  Â  Â  products.forEach(p => set.add(p.category_name || 'Tanpa Kategori'));
Â  Â  Â  Â  categories = ['Semua', ...Array.from(set).filter(Boolean).sort((a,b)=>a.localeCompare(b))];
Â  Â  Â  Â  
Â  Â  Â  Â  renderCategorySidebar(categories);
Â  Â  Â  Â  renderSortOptions();
Â  Â  Â  Â  filterAndSortProducts(); // Terapkan filter & sort setelah data dimuat
Â  Â  Â  Â  
Â  Â  Â  } catch (err) {
Â  Â  Â  Â  console.error('Unexpected error loading products', err);
Â  Â  Â  Â  productListEl.innerHTML = '<div class="col-span-full p-6 bg-red-50 rounded-xl shadow border border-red-200 text-center text-red-700 font-medium">Terjadi kesalahan sistem saat memuat produk.</div>';
Â  Â  Â  Â  errorArea.classList.remove('hidden'); resultCount.textContent = '0 Produk Ditemukan';
Â  Â  Â  }
Â  Â  }

Â  Â  // --- Logic Halaman Detail Produk (Diperbarui tampilannya) ---

Â  Â  function renderProductDetail(p) {
Â  Â  Â  productDetailPage.classList.remove('hidden', 'opacity-0');
Â  Â  Â  productListPage.classList.add('hidden', 'opacity-0');
Â  Â  Â  pageTitleEl.textContent = `${p.name} | Digital Commerce`;

Â  Â  Â  const img = escapeHtml(p.image_url || 'https://placehold.co/800x600/f8fafc/64748b?text=DIGITAL');
Â  Â  Â  const price = (typeof p.price === 'number' || !isNaN(Number(p.price))) ? new Intl.NumberFormat('id-ID').format(Number(p.price)) : '-';
Â  Â  Â  
Â  Â  Â  productDetailPage.innerHTML = `
Â  Â  Â  Â  <a href="/" class="icon-back text-gray-700 hover:text-primary-600 font-medium flex items-center mb-6 transition text-lg" onclick="event.preventDefault(); history.pushState(null, '', '/'); router();">
Â  Â  Â  Â  Â  Kembali ke Katalog
Â  Â  Â  Â  </a>
Â  Â  Â  Â  <div class="bg-white rounded-2xl shadow-2xl p-6 md:p-12 border border-gray-200">
Â  Â  Â  Â  Â  <div class="flex flex-col lg:flex-row gap-10">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="lg:w-1/2">
Â  Â  Â  Â  Â  Â  Â  <div class="aspect-square bg-gray-100 rounded-xl overflow-hidden shadow-xl border-4 border-gray-100">
Â  Â  Â  Â  Â  Â  Â  Â  <img src="${img}" alt="${escapeHtml(p.name)}" class="w-full h-full object-cover">
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="lg:w-1/2">
Â  Â  Â  Â  Â  Â  Â  <span class="inline-block text-xs font-bold text-primary-800 bg-primary-100 px-3 py-1 rounded-full mb-3 uppercase tracking-widest">${escapeHtml(p.category_name || 'Umum')}</span>
Â  Â  Â  Â  Â  Â  Â  <h2 class="text-4xl font-header font-extrabold text-gray-900 mb-4">${escapeHtml(p.name)}</h2>
Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  <div class="flex items-baseline gap-4 mb-8 border-t border-b py-4 border-gray-200">
Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-3xl font-bold text-gray-500">Harga:</span>
Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-5xl font-header font-extrabold text-accent">Rp ${price}</span>
Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  <h3 class="text-2xl font-semibold mb-4 text-gray-800">Tentang Produk</h3>
Â  Â  Â  Â  Â  Â  Â  <p class="text-gray-600 leading-relaxed whitespace-pre-wrap">${escapeHtml(p.description || 'Deskripsi belum tersedia.')}</p>

Â  Â  Â  Â  Â  Â  Â  <button onclick="alert('Checkout untuk ${escapeHtml(p.name)} akan segera diproses!')" class="mt-10 w-full inline-flex items-center justify-center gap-2 bg-accent text-white py-3.5 px-6 rounded-xl text-xl font-bold shadow-2xl hover:bg-blue-600 focus:outline-none focus:ring-4 focus:ring-accent/50 transition duration-300 transform hover:scale-[1.01]">
Â  Â  Â  Â  Â  Â  Â  Â  <span class="icon-cart"></span> Beli Instan & Download
Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  `;
Â  Â  }

Â  Â  async function loadProductDetail(slug) {
Â  Â  Â  // ... (Logika loading dan error handling sama)
Â  Â  Â  productDetailPage.innerHTML = '<div class="text-center p-10 bg-white rounded-xl shadow-lg">Memuat detail produk...</div>';
Â  Â  Â  productListPage.classList.add('hidden', 'opacity-0');
Â  Â  Â  productDetailPage.classList.remove('hidden', 'opacity-0');

Â  Â  Â  try {
Â  Â  Â  Â  const res = await fetch(`${API_PRODUCT_BY_SLUG}${encodeURIComponent(slug)}`);
Â  Â  Â  Â  const parsed = await parseJsonResponse(res);

Â  Â  Â  Â  if (!res.ok) {
Â  Â  Â  Â  Â  productDetailPage.innerHTML = `
Â  Â  Â  Â  Â  Â  <div class="text-center p-20 bg-white rounded-xl shadow-lg border border-red-200">
Â  Â  Â  Â  Â  Â  Â  <p class="text-3xl font-header font-bold text-red-500 mb-4">404 - Tidak Ditemukan</p>
Â  Â  Â  Â  Â  Â  Â  <p class="text-xl text-gray-700">Produk yang Anda cari tidak tersedia.</p>
Â  Â  Â  Â  Â  Â  Â  <a href="/" class="mt-6 icon-back inline-flex items-center text-primary-600 hover:text-primary-800 font-semibold transition" onclick="event.preventDefault(); history.pushState(null, '', '/'); router();">
Â  Â  Â  Â  Â  Â  Â  Â  Kembali ke Katalog
Â  Â  Â  Â  Â  Â  Â  </a>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  pageTitleEl.textContent = '404 - Tidak Ditemukan';
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  renderProductDetail(parsed.json);

Â  Â  Â  } catch (err) {
Â  Â  Â  Â  console.error('Unexpected error loading product detail', err);
Â  Â  Â  Â  productDetailPage.innerHTML = '<div class="text-center p-10 bg-red-50 rounded-xl shadow border border-red-200 text-red-700 font-medium">Terjadi kesalahan sistem saat memuat detail produk.</div>';
Â  Â  Â  }
Â  Â  }

Â  Â  // --- Client-Side Router ---

Â  Â  function router() {
Â  Â  Â  const path = window.location.pathname;
Â  Â  Â  const match = path.match(/^\/product\/([^/]+)$/);
Â  Â  Â  
Â  Â  Â  // Ambil filter & sort dari URL
Â  Â  Â  const urlParams = new URLSearchParams(window.location.search);
Â  Â  Â  
Â  Â  Â  // Update state category
Â  Â  Â  const urlCat = urlParams.get('category');
Â  Â  Â  currentCategory = urlCat ? decodeURIComponent(urlCat) : 'Semua';
Â  Â  Â  
Â  Â  Â  // Update state sort
Â  Â  Â  const urlSortBy = urlParams.get('sort_by') || 'popularity';
Â  Â  Â  const urlSortOrder = urlParams.get('sort_order') || 'desc';
Â  Â  Â  currentSort = `${urlSortBy}-${urlSortOrder}`;

Â  Â  Â  // Update tampilan sort yang dipilih
Â  Â  Â  const selectedOption = SORT_OPTIONS.find(o => o.value === currentSort);
Â  Â  Â  selectedSortNameEl.textContent = selectedOption ? selectedOption.label : 'Populer';

Â  Â  Â  if (match) {
Â  Â  Â  Â  // Rute: /product/:slug
Â  Â  Â  Â  const slug = decodeURIComponent(match[1]);
Â  Â  Â  Â  loadProductDetail(slug);
Â  Â  Â  } else {
Â  Â  Â  Â  // Rute: / atau lainnya (kembali ke daftar produk)
Â  Â  Â  Â  loadProducts();
Â  Â  Â  }
Â  Â  }

Â  Â  // Event Listener Pencarian
Â  Â  document.querySelector('aside input[type="text"]').addEventListener('input', (() => { 
Â  Â  Â  let t; 
Â  Â  Â  return (e) => { 
Â  Â  Â  Â  currentSearchQuery = e.target.value;
Â  Â  Â  Â  clearTimeout(t); 
Â  Â  Â  Â  t = setTimeout(()=>filterAndSortProducts(), 300); 
Â  Â  Â  }; 
Â  Â  })());

Â  Â  // Panggil router saat halaman dimuat dan ketika menggunakan tombol back/forward browser
Â  Â  window.addEventListener('popstate', router);

Â  Â  router();
Â  </script>
</body>
</html>
