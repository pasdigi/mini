<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title id="page-title">Digital Commerce | Toko Digital Instan</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;600;700;800&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Konfigurasi Tailwind CSS untuk tampilan premium dan rapi
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: { // Warna branding (Dark Teal)
              50: '#f0f9ff',
              100: '#e0f2fe',
              200: '#bae6fd',
              500: '#06b6d4', // Cyan/Teal
              600: '#0891b2',
              800: '#075985',
            },
            accent: '#10b981', // Hijau Emerald untuk Aksi/Harga
          }
        },
        fontFamily: {
          sans: ['Inter', 'sans-serif'],
          header: ['Poppins', 'sans-serif'],
        }
      }
    }
  </script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    h1, h2, h3 { font-family: 'Poppins', sans-serif; }
    .icon-back:before { content: "←"; margin-right: 0.5rem; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col">
  <div class="container mx-auto p-4 md:p-8 max-w-7xl flex-grow">
        <header class="mb-8 p-4 bg-white shadow-lg rounded-xl flex justify-between items-center border-b border-primary-200">
      <a href="/" class="flex items-center gap-3 hover:opacity-90 transition" onclick="event.preventDefault(); history.pushState(null, '', '/'); router();">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9.75 17L9 20l-1 1h8l-1-1v-3.25m-7.5 0h15a3 3 0 003-3V8.75a3 3 0 00-3-3h-15a3 3 0 00-3 3V14a3 3 0 003 3.25z" />
        </svg>
        <h1 class="text-xl font-header font-bold text-gray-900">Digital Commerce</h1>
      </a>
      <a href="/admin/login" class="text-xs text-gray-500 hover:text-primary-600 font-medium transition py-1 px-3 border border-gray-200 rounded-lg hover:bg-gray-100">Login Admin</a>
    </header>

        <div id="product-list-page" class="transition-opacity duration-500">
        <h2 class="text-2xl font-header font-semibold text-gray-800 mb-6">Jelajahi Katalog Produk</h2>

        <section class="grid grid-cols-1 lg:grid-cols-[250px,1fr] gap-6 lg:gap-8">
                        <aside x-data="{ searchInput: '' }" class="lg:sticky lg:top-8 h-fit">
                <div class="bg-white p-5 rounded-xl shadow-md border border-gray-100">
                    <h3 class="text-lg font-header font-semibold text-gray-800 mb-4 border-b pb-2">Filter & Kategori</h3>
                    
                                        <input id="search" type="text" x-model="searchInput" placeholder="Cari di Katalog..." class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:border-primary-500 focus:ring-0 transition mb-4">

                                        <div class="space-y-1 max-h-60 overflow-y-auto">
                        <a href="/" class="flex items-center px-3 py-2 text-sm rounded-lg font-medium transition"
                           :class="[window.location.pathname === '/' ? 'bg-primary-50 text-primary-800 font-semibold' : 'text-gray-700 hover:bg-gray-100']"
                           onclick="event.preventDefault(); history.pushState(null, '', '/'); router();">
                            Semua Produk
                        </a>
                        
                        <div id="category-sidebar-list" class="space-y-1">
                                                    </div>
                    </div>
                </div>
            </aside>

                        <div class="lg:flex-1">
                                <div class="flex flex-col sm:flex-row justify-between items-center bg-white p-3 rounded-lg shadow-sm mb-4 border border-gray-200">
                    <div id="result-count" class="text-sm font-medium text-gray-600">Memuat...</div>
                    
                    <div class="relative mt-2 sm:mt-0" x-data="{ open: false }">
                        <button @click="open = !open" type="button" class="inline-flex justify-center items-center px-3 py-1.5 border border-gray-300 shadow-sm text-xs font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-1 focus:ring-primary-500 transition">
                            Urutkan: &nbsp; <span id="selectedSortName" class="font-semibold text-primary-700">Populer</span>
                            <svg class="ml-2 h-3 w-3 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" :class="{ 'rotate-180': open }"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                        </button>
                        <div x-show="open" @click.away="open = false" class="origin-top-right absolute right-0 mt-2 w-48 rounded-lg shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none z-10">
                            <div class="py-1" id="sort-options-list">
                                                            </div>
                        </div>
                    </div>
                </div>
                
                                <main>
                    <div id="product-list" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 md:gap-5">
                        <template id="skeleton">
                            <div class="animate-pulse p-3 bg-white rounded-xl shadow-md border border-gray-100">
                                <div class="w-full aspect-square bg-gray-200 rounded-lg mb-3"></div>
                                <div class="h-3 bg-gray-200 rounded w-3/4 mb-1"></div>
                                <div class="h-3 bg-gray-200 rounded w-1/2 mb-3"></div>
                                <div class="h-6 bg-primary-200 rounded-lg w-full"></div>
                            </div>
                        </template>

                        <div id="loading-container" class="col-span-full">
                            <div class="p-4 bg-white rounded-xl shadow-lg text-center text-primary-600 font-medium">Memuat produk...</div>
                        </div>
                    </div>

                    <div id="error-area" class="mt-6 hidden">
                        <p class="text-red-600 bg-red-50 border border-red-200 p-4 rounded-xl text-center text-sm font-medium">Gagal memuat produk. Silakan coba refresh.</p>
                    </div>
                    
                    <div id="pagination-container" class="mt-6 flex justify-center"></div>
                </main>
            </div>
        </section>
    </div>

        <div id="product-detail-page" class="hidden transition-opacity duration-500">
          </div>
  </div>

    <footer class="mt-8 border-t border-gray-200 py-4 bg-white">
    <div class="container mx-auto max-w-7xl px-4 md:px-8 text-center text-xs text-gray-500">
      <p>&copy; 2025 Digital Commerce. Dibuat dengan Hono & Cloudflare Pages.</p>
    </div>
  </footer>

  <script>
    // --- Utilities (Sama) ---
    function escapeHtml(str) {
      if (typeof str !== 'string') return str == null ? '' : String(str);
      return str.replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]);
    }

    async function parseJsonResponse(res) {
      const txt = await res.text();
      try { return { ok: res.ok, json: JSON.parse(txt), raw: txt }; }
      catch { return { ok: res.ok, json: null, raw: txt }; }
    }

    // --- Konstan & Elemen ---
    const API_PRODUCTS = '/api/store/products';
    const API_PRODUCT_BY_SLUG = '/api/store/products/slug/';
    
    const SORT_OPTIONS = [
      { value: 'popularity-desc', label: 'Populer' },
      { value: 'price-asc', label: 'Harga Termurah' },
      { value: 'price-desc', label: 'Harga Termahal' },
      { value: 'name-asc', label: 'Nama (A-Z)' },
      { value: 'name-desc', label: 'Nama (Z-A)' },
      { value: 'created_at-desc', label: 'Terbaru' },
    ];

    const pageTitleEl = document.getElementById('page-title');
    const productListPage = document.getElementById('product-list-page');
    const productDetailPage = document.getElementById('product-detail-page');

    // Elemen Halaman List
    const productListEl = document.getElementById('product-list');
    const skeletonTmpl = document.getElementById('skeleton');
    const errorArea = document.getElementById('error-area');
    const searchInput = document.getElementById('search');
    const resultCount = document.getElementById('result-count');
    const sortOptionsList = document.getElementById('sort-options-list');
    const selectedSortNameEl = document.getElementById('selectedSortName');
    const categorySidebarList = document.getElementById('category-sidebar-list');

    // State
    let products = [], categories = ['Semua'];
    let currentSearchQuery = '';
    let currentSort = SORT_OPTIONS[0].value;
    let currentCategory = 'Semua';

    // --- Logic Halaman List ---

    function renderSkeletons(count = 10) { // Menambah skeleton
      productListEl.innerHTML = '';
      for (let i = 0; i < count; i++) {
        const node = skeletonTmpl.content.cloneNode(true);
        productListEl.appendChild(node);
      }
    }

    function renderProducts(list) {
      productListEl.innerHTML = '';
      if (!list || list.length === 0) {
        productListEl.innerHTML = '<div class="col-span-full p-4 bg-white rounded-xl shadow-lg text-center text-gray-500 text-sm font-medium">Tidak ada produk yang ditemukan.</div>';
        resultCount.textContent = '0 Produk Ditemukan';
        return;
      }
      list.forEach(p => {
        const img = escapeHtml(p.image_url || 'https://placehold.co/400x400/f8fafc/64748b?text=DIGITAL');
        const name = escapeHtml(p.name || '—');
        const category = escapeHtml(p.category_name || 'Umum');
        // PENTING: Ukuran harga dikecilkan menjadi text-xl atau text-lg
        const price = (typeof p.price === 'number' || !isNaN(Number(p.price))) ? new Intl.NumberFormat('id-ID').format(Number(p.price)) : '-';
        const slugOrId = encodeURIComponent(p.slug || p.id);
        const href = `/product/${slugOrId}`;

        const card = document.createElement('article');
        card.className = 'bg-white rounded-xl shadow-md overflow-hidden border border-gray-100 transition-all duration-300 hover:shadow-xl hover:scale-[1.03] transform';
        
        card.innerHTML = `
          <a href="${href}" class="block" onclick="event.preventDefault(); history.pushState(null, '', '${href}'); router();">
            <div class="w-full aspect-square bg-gray-50 overflow-hidden relative">
              <img loading="lazy" src="${img}" alt="${name}" class="w-full h-full object-cover transition-transform duration-500 hover:scale-[1.1]">
              <span class="absolute top-2 right-2 text-xs font-medium text-gray-700 bg-white px-2 py-0.5 rounded-full shadow-md border border-gray-200">${category}</span>
            </div>
            <div class="p-3">
              <h3 class="text-sm font-semibold mt-1 truncate text-gray-900">${name}</h3>
              <p class="mt-1 text-xl font-bold text-accent">Rp ${price}</p>
              
              <div class="mt-3">
                <button class="w-full inline-flex items-center justify-center gap-1 bg-primary-600 text-white py-2 px-3 rounded-lg shadow-md hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-300 font-medium text-xs transition">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M3 1a1 1 0 000 2h1.22l.305 1.222a.997.997 0 00.01.042l1.358 5.43-.893.892C3.74 11.846 4.35 13 5.378 13h12.5a.5.5 0 000-1H5.378c-.282 0-.58.125-.712.315-.226.297-.367.73-.24 1.144L6 17a1 1 0 001 1h8a1 1 0 100-2H7.071l.78-3.124h8.43c.725 0 1.36-.36 1.733-.948l1.735-2.733a1.001 1.001 0 00.007-.803.996.996 0 00-.734-.693l-4.137-.996L12 8l-.75-3H4.22L3.916 2.042A1 1 0 003 1z" /></svg>
                  Beli Instan
                </button>
              </div>
            </div>
          </a>
        `;
        productListEl.appendChild(card);
      });
      resultCount.textContent = `${list.length} Produk Ditemukan`;
    }

    function renderCategorySidebar(allCategories) {
      categorySidebarList.innerHTML = '';
      allCategories.filter(c => c !== 'Semua').forEach(cat => {
        const link = document.createElement('a');
        // Menggunakan format query yang sama agar router dapat menangkapnya
        link.href = `/?category=${encodeURIComponent(cat)}`; 
        link.textContent = cat;
        link.className = 'flex items-center px-3 py-2 text-sm rounded-lg font-medium transition';
        link.onclick = (e) => {
          e.preventDefault();
          history.pushState(null, '', link.href);
          router();
        };
        
        // Logika highlight category
        if (cat === currentCategory) {
          link.classList.add('bg-primary-100', 'text-primary-800', 'font-semibold');
        } else {
          link.classList.add('text-gray-700', 'hover:bg-gray-100');
        }

        categorySidebarList.appendChild(link);
      });
    }
    
    function renderSortOptions() {
      sortOptionsList.innerHTML = '';
      SORT_OPTIONS.forEach(opt => {
        const [sort_by, sort_order] = opt.value.split('-');
        // Mempertahankan filter kategori saat mengubah sort
        const href = `/?category=${encodeURIComponent(currentCategory)}&sort_by=${sort_by}&sort_order=${sort_order}`;
        
        const link = document.createElement('a');
        link.href = href;
        link.textContent = opt.label;
        link.className = 'text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100 transition';
        
        if (opt.value === currentSort) {
          link.classList.add('bg-primary-50', 'text-primary-800', 'font-semibold');
        }

        link.onclick = (e) => {
          e.preventDefault();
          history.pushState(null, '', link.href);
          router();
        };
        sortOptionsList.appendChild(link);
      });
    }

    function filterAndSortProducts() {
      let list = products.slice();

      // 1. Filter Kategori
      if (currentCategory !== 'Semua') {
        list = list.filter(p => (p.category_name || 'Umum') === currentCategory);
      }

      // 2. Filter Pencarian
      const q = currentSearchQuery.trim().toLowerCase();
      if (q) {
        list = list.filter(p => 
          ((p.name||'').toLowerCase().includes(q) || (p.description||'').toLowerCase().includes(q) || (p.category_name||'').toLowerCase().includes(q))
        );
      }

      // 3. Sorting (Sederhana di sisi klien)
      const [sort_by, sort_order] = currentSort.split('-');
      
      list.sort((a, b) => {
        let valA, valB;
        
        switch(sort_by) {
          case 'price':
            valA = Number(a.price || 0);
            valB = Number(b.price || 0);
            break;
          case 'name':
            valA = a.name.toLowerCase();
            valB = b.name.toLowerCase();
            return sort_order === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
          case 'created_at':
            valA = Number(a.id); 
            valB = Number(b.id);
            break;
          case 'popularity':
          default:
            // Default: Sort by name asc jika popularity tidak jelas
            valA = a.name.toLowerCase();
            valB = b.name.toLowerCase();
            return valA.localeCompare(valB); 
        }
        
        if (sort_by === 'name' || sort_by === 'popularity') return 0; // Sudah ditangani di atas
        return sort_order === 'asc' ? (valA - valB) : (valB - valA);
      });

      renderProducts(list);
      renderCategorySidebar(categories); // Render ulang untuk highlight yang benar
      renderSortOptions(); // Render ulang untuk highlight yang benar
    }

    async function loadProducts() {
      // Tampilkan halaman list, sembunyikan detail
      productListPage.classList.remove('hidden', 'opacity-0');
      productDetailPage.classList.add('hidden', 'opacity-0');
      pageTitleEl.textContent = 'Katalog Produk | Digital Commerce';

      errorArea.classList.add('hidden');
      renderSkeletons(10); 
      
      try {
        const res = await fetch(API_PRODUCTS);
        const parsed = await parseJsonResponse(res);
        
        if (!res.ok) {
          console.error('Load products error:', parsed.raw || parsed.json || res.status);
          productListEl.innerHTML = '<div class="col-span-full p-4 bg-red-50 rounded-xl shadow border border-red-200 text-center text-red-700 text-sm font-medium">Gagal memuat produk dari API.</div>';
          errorArea.classList.remove('hidden'); resultCount.textContent = '0 Produk Ditemukan'; return;
        }
        
        const data = Array.isArray(parsed.json) ? parsed.json : (parsed.json && (parsed.json.data || parsed.json.results || parsed.json.items)) || [];
        products = data.map(p => ({ id: p.id, slug: p.slug, name: p.name, description: p.description, price: p.price, image_url: p.image_url, category_name: p.category_name || p.category }));
        
        const set = new Set();
        products.forEach(p => set.add(p.category_name || 'Umum'));
        categories = ['Semua', ...Array.from(set).filter(Boolean).sort((a,b)=>a.localeCompare(b))];
        
        // Setelah data dimuat, jalankan filter/sort berdasarkan state URL
        filterAndSortProducts(); 
        
      } catch (err) {
        console.error('Unexpected error loading products', err);
        productListEl.innerHTML = '<div class="col-span-full p-4 bg-red-50 rounded-xl shadow border border-red-200 text-center text-red-700 text-sm font-medium">Terjadi kesalahan sistem saat memuat produk.</div>';
        errorArea.classList.remove('hidden'); resultCount.textContent = '0 Produk Ditemukan';
      }
    }

    // --- Logic Halaman Detail Produk ---

    function renderProductDetail(p) {
      productDetailPage.classList.remove('hidden', 'opacity-0');
      productListPage.classList.add('hidden', 'opacity-0');
      pageTitleEl.textContent = `${p.name} | Digital Commerce`;

      const img = escapeHtml(p.image_url || 'https://placehold.co/800x800/f8fafc/64748b?text=PRODUK');
      // PENTING: Ukuran harga dikecilkan menjadi text-3xl
      const price = (typeof p.price === 'number' || !isNaN(Number(p.price))) ? new Intl.NumberFormat('id-ID').format(Number(p.price)) : '-';
      
      productDetailPage.innerHTML = `
        <a href="/" class="icon-back text-gray-700 hover:text-primary-600 font-medium flex items-center mb-6 transition text-sm" onclick="event.preventDefault(); history.pushState(null, '', '/'); router();">
          Kembali ke Katalog
        </a>
        <div class="bg-white rounded-2xl shadow-xl p-6 md:p-10 border border-gray-100">
          <div class="flex flex-col lg:flex-row gap-8">
                        <div class="lg:w-1/2">
              <div class="aspect-square bg-gray-100 rounded-xl overflow-hidden shadow-lg border-4 border-gray-100">
                <img src="${img}" alt="${escapeHtml(p.name)}" class="w-full h-full object-cover">
              </div>
            </div>
                        <div class="lg:w-1/2">
              <span class="inline-block text-xs font-semibold text-primary-800 bg-primary-100 px-2 py-0.5 rounded-full mb-2 uppercase tracking-wide">${escapeHtml(p.category_name || 'Umum')}</span>
              <h2 class="text-3xl font-header font-bold text-gray-900 mb-4">${escapeHtml(p.name)}</h2>
              
              <div class="flex items-baseline gap-3 mb-6 border-t border-b py-3 border-gray-200">
                <span class="text-xl font-semibold text-gray-500">Harga:</span>
                <span class="text-3xl font-header font-extrabold text-accent">Rp ${price}</span>
              </div>

              <h3 class="text-xl font-semibold mb-3 text-gray-800">Deskripsi</h3>
              <p class="text-sm text-gray-600 leading-relaxed whitespace-pre-wrap">${escapeHtml(p.description || 'Deskripsi belum tersedia.')}</p>

              <button onclick="alert('Checkout untuk ${escapeHtml(p.name)} akan segera diproses!')" class="mt-8 w-full inline-flex items-center justify-center gap-2 bg-accent text-white py-3 px-6 rounded-lg text-lg font-bold shadow-lg hover:bg-green-600 focus:outline-none focus:ring-4 focus:ring-accent/50 transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M3 1a1 1 0 000 2h1.22l.305 1.222a.997.997 0 00.01.042l1.358 5.43-.893.892C3.74 11.846 4.35 13 5.378 13h12.5a.5.5 0 000-1H5.378c-.282 0-.58.125-.712.315-.226.297-.367.73-.24 1.144L6 17a1 1 0 001 1h8a1 1 0 100-2H7.071l.78-3.124h8.43c.725 0 1.36-.36 1.733-.948l1.735-2.733a1.001 1.001 0 00.007-.803.996.996 0 00-.734-.693l-4.137-.996L12 8l-.75-3H4.22L3.916 2.042A1 1 0 003 1z" /></svg>
                Beli Instan & Download
              </button>
            </div>
          </div>
        </div>
      `;
    }

    async function loadProductDetail(slug) {
      productDetailPage.innerHTML = '<div class="text-center p-10 bg-white rounded-xl shadow-lg">Memuat detail produk...</div>';
      productListPage.classList.add('hidden', 'opacity-0');
      productDetailPage.classList.remove('hidden', 'opacity-0');

      try {
        const res = await fetch(`${API_PRODUCT_BY_SLUG}${encodeURIComponent(slug)}`);
        const parsed = await parseJsonResponse(res);

        if (!res.ok) {
          productDetailPage.innerHTML = `
            <div class="text-center p-10 bg-white rounded-xl shadow-lg border border-red-200">
              <p class="text-xl font-header font-bold text-red-500 mb-3">404 - Tidak Ditemukan</p>
              <p class="text-sm text-gray-700">Produk yang Anda cari tidak tersedia.</p>
              <a href="/" class="mt-4 icon-back inline-flex items-center text-primary-600 hover:text-primary-800 font-medium transition" onclick="event.preventDefault(); history.pushState(null, '', '/'); router();">
                Kembali ke Katalog
              </a>
            </div>
          `;
          pageTitleEl.textContent = '404 - Tidak Ditemukan';
          return;
        }

        renderProductDetail(parsed.json);

      } catch (err) {
        console.error('Unexpected error loading product detail', err);
        productDetailPage.innerHTML = '<div class="text-center p-4 bg-red-50 rounded-xl shadow border border-red-200 text-red-700 text-sm font-medium">Terjadi kesalahan sistem saat memuat detail produk.</div>';
      }
    }

    // --- Client-Side Router & Event Handlers (Sama) ---

    function router() {
      const path = window.location.pathname;
      const match = path.match(/^\/product\/([^/]+)$/);
      
      const urlParams = new URLSearchParams(window.location.search);
      
      const urlCat = urlParams.get('category');
      currentCategory = urlCat ? decodeURIComponent(urlCat) : 'Semua';
      
      const urlSortBy = urlParams.get('sort_by') || 'popularity';
      const urlSortOrder = urlParams.get('sort_order') || 'desc';
      currentSort = `${urlSortBy}-${urlSortOrder}`;

      const selectedOption = SORT_OPTIONS.find(o => o.value === currentSort);
      selectedSortNameEl.textContent = selectedOption ? selectedOption.label : 'Populer';

      if (match) {
        const slug = decodeURIComponent(match[1]);
        loadProductDetail(slug);
      } else {
        loadProducts();
      }
    }

    // Event Listener Pencarian
    searchInput.addEventListener('input', (() => { 
      let t; 
      return (e) => { 
        currentSearchQuery = e.target.value;
        clearTimeout(t); 
        t = setTimeout(()=>filterAndSortProducts(), 300); 
      }; 
    })());

    // Memastikan link internal yang mengarah ke home menggunakan router
    document.querySelector('header a[href="/"]').addEventListener('click', (e) => {
      e.preventDefault();
      history.pushState(null, '', '/');
      router();
    });
    
    window.addEventListener('popstate', router);
    router();
  </script>
</body>
</html>
