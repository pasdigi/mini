<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mini Commerce — Toko Digital</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">
  <div class="container mx-auto p-4 max-w-6xl">
    <header class="mb-6">
      <h1 class="text-4xl font-bold">Toko Digital</h1>
      <p class="text-gray-600 mt-1">Produk digital instan dikirim ke email Anda.</p>
    </header>

    <section id="controls" class="mb-6">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <div class="flex items-center gap-3">
          <input id="search" type="search" placeholder="Cari produk..." class="px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-400" />
          <div id="category-pills" class="flex gap-2 overflow-x-auto py-1"></div>
        </div>

        <div class="text-sm text-gray-500 self-end sm:self-auto">
          <span id="result-count">Memuat...</span>
        </div>
      </div>
    </section>

    <main>
      <div id="product-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
        <template id="skeleton">
          <div class="animate-pulse p-4 bg-white rounded-lg shadow">
            <div class="w-full h-40 bg-gray-200 rounded-md mb-3"></div>
            <div class="h-4 bg-gray-200 rounded w-3/4 mb-2"></div>
            <div class="h-4 bg-gray-200 rounded w-1/2"></div>
          </div>
        </template>

        <div id="loading-container" class="col-span-full">
          <div class="p-4 bg-white rounded-lg shadow text-center text-gray-500">Memuat produk...</div>
        </div>
      </div>

      <div id="error-area" class="mt-6 hidden">
        <p class="text-red-600">Gagal memuat produk. Silakan coba refresh.</p>
      </div>
    </main>
  </div>

  <script>
    function escapeHtml(str) {
      if (typeof str !== 'string') return str == null ? '' : String(str);
      return str.replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]);
    }

    async function parseJsonResponse(res) {
      const txt = await res.text();
      try { return { ok: res.ok, json: JSON.parse(txt), raw: txt }; }
      catch { return { ok: res.ok, json: null, raw: txt }; }
    }

    const API_PRODUCTS = '/api/store/products';
    const productListEl = document.getElementById('product-list');
    const skeletonTmpl = document.getElementById('skeleton');
    const errorArea = document.getElementById('error-area');
    const searchInput = document.getElementById('search');
    const categoryPills = document.getElementById('category-pills');
    const resultCount = document.getElementById('result-count');

    let products = [], filtered = [], categories = ['Semua'];

    function renderSkeletons(count = 6) {
      productListEl.innerHTML = '';
      for (let i = 0; i < count; i++) {
        const node = skeletonTmpl.content.cloneNode(true);
        productListEl.appendChild(node);
      }
    }

    function renderProducts(list) {
      productListEl.innerHTML = '';
      if (!list || list.length === 0) {
        productListEl.innerHTML = '<div class="col-span-full p-6 bg-white rounded-lg shadow text-center text-gray-500">Belum ada produk.</div>';
        resultCount.textContent = '0 produk';
        return;
      }
      list.forEach(p => {
        const img = escapeHtml(p.image_url || 'https://placehold.co/600x400/e2e8f0/cbd5e0?text=Produk');
        const name = escapeHtml(p.name || '—');
        const category = escapeHtml(p.category_name || 'Tanpa Kategori');
        const price = (typeof p.price === 'number' || !isNaN(Number(p.price))) ? new Intl.NumberFormat('id-ID').format(Number(p.price)) : '-';
        const slugOrId = encodeURIComponent(p.slug || p.id);
        const href = `/product/${slugOrId}`;

        const card = document.createElement('article');
        card.className = 'bg-white rounded-lg shadow-md overflow-hidden transition-transform duration-200 hover:scale-105';
        card.innerHTML = `
          <a href="${href}" class="block">
            <div class="w-full h-48 bg-gray-100 overflow-hidden">
              <img loading="lazy" src="${img}" alt="${name}" class="w-full h-full object-cover">
            </div>
            <div class="p-4">
              <div class="flex items-center justify-between gap-2">
                <span class="text-xs font-semibold text-blue-600 bg-blue-50 px-2 py-1 rounded-full">${category}</span>
                <span class="text-sm font-medium text-gray-700">Rp ${price}</span>
              </div>
              <h3 class="text-lg font-semibold mt-3 truncate">${name}</h3>
              <p class="mt-2 text-sm text-gray-600 line-clamp-2">${escapeHtml(p.description || '')}</p>
              <div class="mt-4">
                <button class="w-full inline-flex items-center justify-center gap-2 bg-blue-600 text-white py-2 px-3 rounded shadow hover:bg-blue-700 focus:outline-none">
                  Beli Sekarang
                </button>
              </div>
            </div>
          </a>
        `;
        productListEl.appendChild(card);
      });
      resultCount.textContent = `${list.length} produk`;
    }

    function renderCategoryPills() {
      categoryPills.innerHTML = '';
      categories.forEach(cat => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.textContent = cat;
        btn.className = 'px-3 py-1 rounded-full text-sm border border-gray-200 bg-white hover:bg-gray-50 whitespace-nowrap';
        if (cat === 'Semua') btn.classList.add('bg-blue-600', 'text-white', 'border-blue-600');
        btn.addEventListener('click', () => {
          Array.from(categoryPills.children).forEach(c => c.classList.remove('bg-blue-600','text-white','border-blue-600'));
          btn.classList.add('bg-blue-600','text-white','border-blue-600');
          filterByCategory(cat);
        });
        categoryPills.appendChild(btn);
      });
    }

    function filterByCategory(cat) {
      if (cat === 'Semua') applySearch(products);
      else applySearch(products.filter(p => (p.category_name || 'Tanpa Kategori') === cat));
    }

    function applySearch(list) {
      const q = (searchInput.value || '').trim().toLowerCase();
      if (!q) filtered = list.slice();
      else filtered = list.filter(p => ((p.name||'').toLowerCase().includes(q) || (p.description||'').toLowerCase().includes(q) || (p.category_name||'').toLowerCase().includes(q)));
      renderProducts(filtered);
    }

    async function loadProducts() {
      errorArea.classList.add('hidden');
      renderSkeletons(6);
      try {
        const res = await fetch(API_PRODUCTS);
        const parsed = await parseJsonResponse(res);
        if (!res.ok) {
          console.error('Load products error:', parsed.raw || parsed.json || res.status);
          productListEl.innerHTML = '<div class="col-span-full p-6 bg-white rounded-lg shadow text-center text-red-500">Gagal memuat produk.</div>';
          errorArea.classList.remove('hidden'); resultCount.textContent = '0 produk'; return;
        }
        const data = Array.isArray(parsed.json) ? parsed.json : (parsed.json && (parsed.json.data || parsed.json.results || parsed.json.items)) || [];
        products = data.map(p => ({ id: p.id, slug: p.slug, name: p.name, description: p.description, price: p.price, image_url: p.image_url, category_name: p.category_name || p.category }));
        const set = new Set();
        products.forEach(p => set.add(p.category_name || 'Tanpa Kategori'));
        categories = ['Semua', ...Array.from(set).filter(Boolean).sort((a,b)=>a.localeCompare(b))];
        renderCategoryPills();
        applySearch(products);
      } catch (err) {
        console.error('Unexpected error loading products', err);
        productListEl.innerHTML = '<div class="col-span-full p-6 bg-white rounded-lg shadow text-center text-red-500">Gagal memuat produk.</div>';
        errorArea.classList.remove('hidden'); resultCount.textContent = '0 produk';
      }
    }

    searchInput.addEventListener('input', (() => { let t; return () => { clearTimeout(t); t = setTimeout(()=>applySearch(products), 250); }; })());

    loadProducts();
  </script>
</body>
</html>
